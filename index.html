<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã•ãã‚„ã¡ã‚ƒã‚“ ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ã‚ºãƒ«</title>
    
    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuOBleOBj+OChuOBoeOCg+OCkyDjgrnjg6njgqTjg4njg5Hjgrrjg6siLAogICJzaG9ydF9uYW1lIjogIuOCueODqeOCpOODieODkeOCuuODqyIsCiAgImRlc2NyaXB0aW9uIjogIjPDlzMg44K544Op44Kk44OJ44OR44K644Or44Ky44O844OgIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmIiwKICAidGhlbWVfY29sb3IiOiAiI2ZmNmI5ZCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBSEFBQUFCd0NBTUFBQUI4QUFBQUFBQUFBWE5TUjBJQXJzNGM2UUFBQUFSblFVMUJBQUN4and2OFlRVUFBQUFKY0VoWmN3QUFHZEFBQUJUV0FSalJ5dTBBQUFBTUVsRVFWUjQybU5rWUhYWUFBQUFBRWxGVGtTdVFtQ0MiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
    
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            min-height: 100vh; 
            margin: 0; 
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%); 
            padding: 10px;
            touch-action: manipulation;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -ms-touch-action: manipulation;
            overscroll-behavior: contain;
        }
        .game-container {
            background: white; 
            border-radius: 20px; 
            padding: 15px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            text-align: center; 
            max-width: 95vw; 
            width: 100%;
        }
        h1 {
            color: #ff6b9d; 
            margin: 5px 0; 
            font-size: clamp(1.5em, 5vw, 2em);
        }
        .subtitle {
            display: none;
        }
        .top-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }
        .reference-image {
            width: min(120px, 30vw); 
            height: min(120px, 30vw); 
            border-radius: 8px; 
            border: 2px solid #ff6b9d;
        }
        .stats {
            display: flex; 
            justify-content: center;
            gap: 15px;
            width: 100%;
        }
        .stat {
            background: #f8f9ff; 
            padding: 8px 12px; 
            border-radius: 10px;
            text-align: center;
            min-width: 60px;
        }
        .stat-number {
            font-size: clamp(16px, 4vw, 20px); 
            font-weight: bold; 
            color: #ff6b9d;
        }
        .stat-label {
            font-size: clamp(10px, 2.5vw, 12px); 
            color: #666; 
            margin-top: 2px;
        }
        .puzzle-container {
            display: inline-block; 
            border: 4px solid #ff6b9d; 
            border-radius: 15px; 
            background: #f8f8f8; 
            padding: 8px; 
            margin: 10px 0;
        }
        .puzzle-grid {
            display: grid; 
            grid-template-columns: repeat(3, var(--piece-size)); 
            grid-template-rows: repeat(3, var(--piece-size)); 
            gap: 3px; 
            background: #ddd; 
            padding: 3px; 
            border-radius: 10px;
            --piece-size: min(160px, calc((100vw - 50px) / 3 - 6px));
        }
        .puzzle-piece {
            background-size: calc(var(--piece-size) * 3) calc(var(--piece-size) * 3); 
            border: 2px solid #fff; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: transform 0.1s ease, box-shadow 0.1s ease; 
            position: relative; 
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -ms-touch-action: manipulation;
            user-select: none;
            width: var(--piece-size);
            height: var(--piece-size);
            /* Android Chromeå¯¾å¿œ */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            will-change: transform;
        }
        .puzzle-piece:hover, .puzzle-piece:active {
            transform: scale(1.03); 
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }
        .puzzle-piece:active {
            transform: scale(0.98);
            transition: transform 0.05s ease;
        }
        .puzzle-piece.empty {
            background: #f0f0f0 !important; 
            border: 2px dashed #ccc; 
            cursor: default;
        }
        .puzzle-piece.empty:hover, .puzzle-piece.empty:active {
            transform: none; 
            box-shadow: none;
        }
        .puzzle-piece.locked {
            opacity: 0.7;
            cursor: not-allowed !important;
            background-color: #c0c0c0 !important;
        }
        .puzzle-piece.locked:hover, .puzzle-piece.locked:active {
            transform: none !important;
            box-shadow: none !important;
        }
        }
        .puzzle-piece.super-hint-piece {
            animation: pulse 1s infinite;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.8) !important;
            position: relative;
        }
        .puzzle-piece.super-hint-piece::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, rgba(255, 68, 68, 0.5), rgba(204, 0, 0, 0.5));
            border-radius: 8px;
            pointer-events: none;
        }
        .puzzle-piece.super-hint-target {
            border: 4px solid #ff4444 !important;
            animation: borderGlow 1s infinite alternate;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.8) !important;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes borderGlow {
            0% { border-color: #ff4444; box-shadow: 0 0 15px rgba(255, 68, 68, 0.8); }
            100% { border-color: #ff0000; box-shadow: 0 0 25px rgba(255, 0, 0, 1); }
        }
        .hint-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(24px, 6vw, 36px);
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .controls {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            background: linear-gradient(45deg, #ff6b9d, #ff8fab); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: clamp(12px, 3vw, 14px); 
            font-weight: bold; 
            transition: transform 0.1s ease, box-shadow 0.1s ease; 
            box-shadow: 0 4px 15px rgba(255,107,157,0.3);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            min-height: 44px;
            min-width: 80px;
        }
        button:hover, button:active {
            transform: translateY(-1px); 
            box-shadow: 0 5px 18px rgba(255,107,157,0.4);
        }
        button:active {
            transform: translateY(0px) scale(0.98);
            transition: transform 0.05s ease;
        }
        .hint-button {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
        }
        .hint-button.active {
            background: linear-gradient(45deg, #FF9800, #FFC107);
        }
        .super-hint-button {
            background: linear-gradient(45deg, #ff4444, #ff6666);
            animation: rainbow 2s infinite;
            font-weight: bold;
        }
        @keyframes rainbow {
            0% { background: linear-gradient(45deg, #ff4444, #ff6666); }
            33% { background: linear-gradient(45deg, #4CAF50, #8BC34A); }
            66% { background: linear-gradient(45deg, #2196F3, #64B5F6); }
            100% { background: linear-gradient(45deg, #ff4444, #ff6666); }
        }
        .hint-message {
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
            border: 3px solid #ff6b9d;
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            font-size: clamp(16px, 4vw, 18px);
            font-weight: bold;
            color: #2c3e50;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.2);
            line-height: 1.4;
        }
        .hint-message .step-number {
            color: #ff4444;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(255, 68, 68, 0.3);
        }
        .hint-message .target-position {
            color: #4CAF50;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(76, 175, 80, 0.3);
        }
        .victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .victory-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 350px;
            animation: circleAppear 0.5s ease-in-out;
        }
        .victory-popup {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            max-width: 90vw;
            min-width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: popupSlide 0.5s ease-in-out 0.3s both;
        }
        @keyframes circleAppear {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        @keyframes popupSlide {
            0% { transform: translateX(-50%) translateY(100px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .victory-message {
            display: none;
        }
        @keyframes celebrate {
            0% { transform: scale(0.8); opacity: 0; } 
            50% { transform: scale(1.1); } 
            100% { transform: scale(1); opacity: 1; }
        }
        @media (max-width: 480px) {
            .game-container {
                padding: 15px;
                margin: 5px;
            }
            .puzzle-container {
                padding: 5px;
                margin: 10px 0;
            }
            .controls {
                margin: 10px 0;
            }
            button {
                padding: 10px 16px;
                margin: 3px;
            }
            .hint-message {
                padding: 15px;
                font-size: clamp(14px, 3.5vw, 16px);
            }
        }
        @media (max-width: 320px) {
            .puzzle-grid {
                --piece-size: calc((100vw - 60px) / 3 - 8px);
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ğŸŒ¸ ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ã‚ºãƒ« ğŸŒ¸</h1>
        <p class="subtitle">3Ã—3 ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ã‚ºãƒ«</p>
        
        <div class="top-section">
            <canvas id="referenceImage" class="reference-image" width="120" height="120"></canvas>
            <div class="stats">
                <div class="stat">
                    <div class="stat-number" id="moveCount">0</div>
                    <div class="stat-label">æ‰‹æ•°</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="timeCount">00:00</div>
                    <div class="stat-label">æ™‚é–“</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="bestTimeDisplay">--</div>
                    <div class="stat-label">ãƒ™ã‚¹ãƒˆ</div>
                </div>
            </div>
        </div>
        
        <div class="puzzle-container">
            <div class="puzzle-grid" id="puzzleGrid"></div>
        </div>
        
        <div id="hintMessage" class="hint-message">
            ã€Œè¶…ãƒ’ãƒ³ãƒˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æ¬¡ã«é…ç½®ã™ã¹ããƒ”ãƒ¼ã‚¹ã¨ä½ç½®ã‚’æ•™ãˆã¾ã™ï¼
        </div>
        
        <div class="victory-overlay" id="victoryOverlay">
            <div class="victory-circle">â­•</div>
            <div class="victory-popup" id="victoryPopup"></div>
        </div>
        
        <div class="victory-message" id="victoryMessage">
            ğŸ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ãƒ‘ã‚ºãƒ«å®Œæˆã§ã™ï¼ ğŸ‰
        </div>
        
        <div class="controls">
            <button onclick="shufflePuzzle()">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
            <button onclick="toggleHint()" class="hint-button" id="hintButton">ãƒ’ãƒ³ãƒˆ</button>
            <button onclick="showSuperHint()" class="super-hint-button" id="superHintButton">âœ¨ è¶…ãƒ’ãƒ³ãƒˆ</button>
        </div>
    </div>
    <script>
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã‚’ä½œæˆ
        function createDefaultImage() {
            const canvas = document.createElement('canvas');
            canvas.width = 360;
            canvas.height = 360;
            const ctx = canvas.getContext('2d');
            
            const gradient = ctx.createLinearGradient(0, 0, 360, 360);
            gradient.addColorStop(0, '#ff9a9e');
            gradient.addColorStop(0.5, '#fad0c4');
            gradient.addColorStop(1, '#a18cd1');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 360, 360);
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            for (let i = 0; i < 9; i++) {
                const x = (i % 3) * 120 + 20;
                const y = Math.floor(i / 3) * 120 + 20;
                ctx.beginPath();
                ctx.arc(x + 40, y + 40, 30, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText((i + 1).toString(), x + 40, y + 40);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            }
            
            return canvas.toDataURL();
        }

        //--- ãƒ‘ã‚ºãƒ«ç”¨å¤‰æ•° ---
        let puzzle = [];
        let emptyPos = 8;
        let moveCount = 0;
        let startTime = null;
        let timerInterval = null;
        let isGameActive = false;
        let imageData = null;
        let showHints = false;
        let bestTime = null;
        let hintUsedThisRound = false;

        // è¶…ãƒ’ãƒ³ãƒˆæ©Ÿèƒ½ç”¨å¤‰æ•°
        let currentSuperHint = null;
        let superHintActive = false;

        //--- ç”»åƒé¸æŠã›ãšã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã§é–‹å§‹ ---
        window.onload = function() {
            // PWA Service Workerç™»éŒ²
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdzbGlkZS1wdXp6bGUtdjEnOwpjb25zdCB1cmxzVG9DYWNoZSA9IFsKICAnLi8nLAogICcuL2luZGV4Lmh0bWwnCl07CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCBldmVudCA9PiB7CiAgZXZlbnQud2FpdFVudGlsKAogICAgY2FjaGVzLm9wZW4oQ0FDSEVfTkFNRSkKICAgICAgLnRoZW4oY2FjaGUgPT4gewogICAgICAgIHJldHVybiBjYWNoZS5hZGRBbGwodXJsc1RvQ2FjaGUpOwogICAgICB9KQogICk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsKICBldmVudC5yZXNwb25kV2l0aCgKICAgIGNhY2hlcy5tYXRjaChldmVudC5yZXF1ZXN0KQogICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlIHx8IGZldGNoKGV2ZW50LnJlcXVlc3QpOwogICAgICB9KQogICk7Cn0pOw==')
                .then(() => console.log('PWA Service Worker registered'))
                .catch(err => console.log('PWA Service Worker registration failed'));
            }

            // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã“ã“ã‚’ä¿®æ­£
            imageData = 'sakuya.png';  // â† æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã«å¤‰æ›´
            console.log('Loading sakuya.png...');
            
            // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const testImg = new Image();
            testImg.onerror = function() {
                console.log('ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚’ä½¿ç”¨');
                imageData = createDefaultImage();
                setTimeout(() => {
                    initializePuzzle();
                    updatePuzzleGridSize();
                }, 100);
            };
            testImg.onload = function() {
                console.log('ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸï¼');
                setTimeout(() => {
                    initializePuzzle();
                    updatePuzzleGridSize();
                }, 200);
            };
            testImg.src = imageData;
        }

        // ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®èª¿æ•´
        window.addEventListener('resize', updatePuzzleGridSize);

        function updatePuzzleGridSize() {
            const puzzleGrid = document.getElementById('puzzleGrid');
            const containerWidth = Math.min(window.innerWidth - 50, 500);
            const pieceSize = Math.min(160, (containerWidth - 30) / 3 - 6);
            
            puzzleGrid.style.setProperty('--piece-size', pieceSize + 'px');
            
            createReferenceImage();
            
            if (puzzle.length > 0) {
                renderPuzzle();
            }
        }

        function createReferenceImage() {
            const canvas = document.getElementById('referenceImage');
            const ctx = canvas.getContext('2d');
            
            const refSize = Math.min(120, window.innerWidth * 0.3);
            canvas.width = refSize;
            canvas.height = refSize;
            canvas.style.width = refSize + 'px';
            canvas.style.height = refSize + 'px';
            
            const img = new Image();
            img.onload = function() {
                try {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                } catch (e) {
                    console.log('Canvas drawing error:', e);
                    createFallbackReferenceImage();
                }
            };
            img.onerror = function() {
                console.log('Image load error');
                createFallbackReferenceImage();
            };
            img.src = imageData;
        }
        
        function createFallbackReferenceImage() {
            const canvas = document.getElementById('referenceImage');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#ff6b9d';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('è¦‹æœ¬', canvas.width / 2, canvas.height / 2);
        }

        function initializePuzzle() {
            puzzle = [1, 2, 3, 4, 5, 6, 7, 8, 0]; // æ–°ã—ã„ç•ªå·ä½“ç³»
            emptyPos = 8;
            hintUsedThisRound = false;
            clearSuperHint();
            createReferenceImage();
            renderPuzzle();
            moveCount = 0;
            document.getElementById('moveCount').textContent = moveCount;
            document.getElementById('timeCount').textContent = '00:00';
            document.getElementById('victoryMessage').style.display = 'none';
        }

        function renderPuzzle() {
            const grid = document.getElementById('puzzleGrid');
            const currentPieceSize = getComputedStyle(grid).getPropertyValue('--piece-size');
            const pieceSize = parseInt(currentPieceSize);
            
            grid.innerHTML = '';
            
            for (let i = 0; i < 9; i++) {
                const piece = document.createElement('div');
                piece.className = 'puzzle-piece';
                
                if (puzzle[i] === 0) {
                    piece.classList.add('empty');
                } else {
                    const row = Math.floor((puzzle[i] - 1) / 3);
                    const col = (puzzle[i] - 1) % 3;
                    piece.style.backgroundImage = `url(${imageData})`;
                    piece.style.backgroundPosition = `-${col * pieceSize}px -${row * pieceSize}px`;
                    
                    // ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
                    const isTopRowComplete = puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3;
                    const isLeftColumnComplete = puzzle[0] === 1 && puzzle[3] === 4 && puzzle[6] === 7;
                    
                    if ((isTopRowComplete && (i === 0 || i === 1 || i === 2)) || 
                        (isLeftColumnComplete && (i === 0 || i === 3 || i === 6))) {
                        piece.classList.add('locked');
                        piece.title = isTopRowComplete && (i === 0 || i === 1 || i === 2) ? 
                                      'ä¸Šæ®µå®Œæˆæ¸ˆã¿ - å‹•ã‹ã›ã¾ã›ã‚“' : 'å·¦åˆ—å®Œæˆæ¸ˆã¿ - å‹•ã‹ã›ã¾ã›ã‚“';
                    } else {
                        // ã‚¿ãƒƒãƒã¨ã‚¯ãƒªãƒƒã‚¯ã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆï¼ˆAndroidå¯¾å¿œå¼·åŒ–ï¼‰
                        let touchStarted = false;
                        
                        const handlePieceAction = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            movePiece(i);
                        };
                        
                        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼‰
                        piece.addEventListener('click', handlePieceAction, { passive: false });
                        
                        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰
                        piece.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            touchStarted = true;
                            piece.classList.add('touching');
                        }, { passive: false });
                        
                        piece.addEventListener('touchmove', (e) => {
                            // æŒ‡ãŒå‹•ã„ãŸå ´åˆã¯ç„¡åŠ¹åŒ–
                            if (e.touches.length > 0) {
                                const touch = e.touches[0];
                                const rect = piece.getBoundingClientRect();
                                const x = touch.clientX - rect.left;
                                const y = touch.clientY - rect.top;
                                
                                if (x < 0 || x > rect.width || y < 0 || y > rect.height) {
                                    touchStarted = false;
                                    piece.classList.remove('touching');
                                }
                            }
                        }, { passive: false });
                        
                        piece.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            piece.classList.remove('touching');
                            
                            if (touchStarted) {
                                // Android Chromeã§ã®é…å»¶ã‚’å›é¿
                                setTimeout(() => {
                                    movePiece(i);
                                }, 0);
                            }
                            touchStarted = false;
                        }, { passive: false });
                        
                        piece.addEventListener('touchcancel', (e) => {
                            piece.classList.remove('touching');
                            touchStarted = false;
                        }, { passive: false });
                    }
                    
                    const hintNumber = document.createElement('div');
                    hintNumber.className = 'hint-number';
                    hintNumber.textContent = puzzle[i];
                    
                    if (showHints) {
                        hintNumber.style.opacity = '1';
                    } else {
                        hintNumber.style.opacity = '0';
                    }
                    
                    piece.appendChild(hintNumber);
                }
                grid.appendChild(piece);
            }
            
            // è¶…ãƒ’ãƒ³ãƒˆãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é©ç”¨
            if (superHintActive && currentSuperHint) {
                applySuperHint();
            }
        }

        function movePiece(pos) {
            // ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
            const isTopRowComplete = puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3;
            const isLeftColumnComplete = puzzle[0] === 1 && puzzle[3] === 4 && puzzle[6] === 7;
            
            if ((isTopRowComplete && (pos === 0 || pos === 1 || pos === 2)) || 
                (isLeftColumnComplete && (pos === 0 || pos === 3 || pos === 6))) {
                return; // ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãƒ”ãƒ¼ã‚¹ã¯å‹•ã‹ã›ãªã„
            }
            
            if (!canMove(pos)) return;
            if (!isGameActive) { startGame(); }
            
            [puzzle[pos], puzzle[emptyPos]] = [puzzle[emptyPos], puzzle[pos]];
            emptyPos = pos;
            moveCount++;
            document.getElementById('moveCount').textContent = moveCount;
            
            // è¶…ãƒ’ãƒ³ãƒˆæ‰‹é †å®Œäº†ãƒã‚§ãƒƒã‚¯
            if (superHintActive && currentSuperHint) {
                checkSuperHintCompletion();
            }
            
            renderPuzzle();
            
            if (checkWin()) { endGame(); }
        }

        function canMove(pos) {
            const row = Math.floor(pos / 3);
            const col = pos % 3;
            const emptyRow = Math.floor(emptyPos / 3);
            const emptyCol = emptyPos % 3;
            return (Math.abs(row - emptyRow) === 1 && col === emptyCol) ||
                (Math.abs(col - emptyCol) === 1 && row === emptyRow);
        }

        // è¶…ãƒ’ãƒ³ãƒˆæ©Ÿèƒ½
        function showSuperHint() {
            if (checkWin()) {
                document.getElementById('hintMessage').innerHTML = 'ğŸ‰ ã™ã§ã«å®Œæˆã—ã¦ã„ã¾ã™ï¼';
                return;
            }
            
            // Lå­—å‹å®Œæˆãƒã‚§ãƒƒã‚¯ - æœ€å„ªå…ˆ
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[3] === 4 && puzzle[6] === 7) {
                superHintActive = false;
                currentSuperHint = null;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ‰ <strong style="color: #4CAF50; font-size: 1.2em;">å®Œç’§ï¼ã“ã†ãªã£ãŸã‚‰ã‚ã¨ã¯ãƒ‘ãƒãƒ«ã‚’å›è»¢ã•ã›ã‚‹ã ã‘ã§å®Œæˆã§ã™ã€‚</strong>`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †1: â‘ ã‚’å·¦ä¸Šã«é…ç½®
            if (puzzle[0] !== 1) {
                const pieceOneIndex = puzzle.indexOf(1);
                currentSuperHint = {
                    from: pieceOneIndex,
                    to: 0,
                    piece: 1,
                    step: 1
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="step-number">â‘ </span>ã‚’<span class="target-position">å·¦ä¸Š</span>ã«é…ç½®ã—ã¦ãã ã•ã„`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †6: â‘ ã¨â‘¢ãŒæ­£ã—ã„ä½ç½®ã«ã‚ã‚Šã€â‘¡ãŒä½ç½®1ã«ãªã„å ´åˆ
            if (puzzle[0] === 1 && puzzle[2] === 3 && puzzle[1] !== 2) {
                const pieceTwoIndex = puzzle.indexOf(2);
                currentSuperHint = {
                    from: pieceTwoIndex,
                    to: 1,
                    piece: 2,
                    step: 6
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="step-number">â‘¡</span>ã‚’<span class="target-position">ä¸Šã®ä¸­å¤®</span>ã«ç§»å‹•ã—ã¦ãã ã•ã„`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †7: â‘£ã‚’å·¦ä¸‹ã¸ç§»å‹•ï¼ˆä¸Šæ®µå®Œæˆå¾Œï¼‰
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[6] !== 4 && puzzle[3] !== 4) {
                const pieceFourIndex = puzzle.indexOf(4);
                currentSuperHint = {
                    from: pieceFourIndex,
                    to: 6,
                    piece: 4,
                    step: 7
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="step-number">â‘£</span>ã‚’<span class="target-position">å·¦ä¸‹</span>ã¸ç§»å‹•ã—ã¦ãã ã•ã„`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †8: â‘¦ã‚’å³ä¸‹ã¸ç§»å‹•
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[6] === 4 && puzzle[8] !== 7 && puzzle[7] !== 7) {
                const pieceSevenIndex = puzzle.indexOf(7);
                currentSuperHint = {
                    from: pieceSevenIndex,
                    to: 8,
                    piece: 7,
                    step: 8
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="step-number">â‘¦</span>ã‚’<span class="target-position">å³ä¸‹</span>ã¸ç§»å‹•ã—ã¦ãã ã•ã„`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †9: â‘¦ã‚’â‘£ã®å³å´ã¸ç§»å‹•
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[6] === 4 && puzzle[7] !== 7) {
                const pieceSevenIndex = puzzle.indexOf(7);
                currentSuperHint = {
                    from: pieceSevenIndex,
                    to: 7,
                    piece: 7,
                    step: 9
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="step-number">â‘¦</span>ã‚’<span class="target-position">â‘£ã®å³å´</span>ã¸ç§»å‹•ã—ã¦ãã ã•ã„`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †10: â‘£ã®ä¸Šã‚’ç©ºç™½ã«ã™ã‚‹
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[6] === 4 && puzzle[7] === 7 && puzzle[3] !== 0) {
                const pieceAtPosition3 = puzzle[3];
                currentSuperHint = {
                    from: 3,
                    to: null,
                    piece: pieceAtPosition3,
                    step: 10
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="target-position">â‘£ã®ä¸Š</span>ã‚’<span class="step-number">ç©ºç™½</span>ã«ã—ã¦ãã ã•ã„`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †11: â‘£ã‚’ä¸Šã«ç§»å‹•
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[6] === 4 && puzzle[7] === 7 && puzzle[3] === 0 && puzzle[3] !== 4) {
                const pieceFourIndex = puzzle.indexOf(4);
                currentSuperHint = {
                    from: pieceFourIndex,
                    to: 3,
                    piece: 4,
                    step: 11
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="step-number">â‘£</span>ã‚’<span class="target-position">ä¸Šã«ç§»å‹•</span>ã—ã¦ãã ã•ã„`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †12: â‘¦ã‚’å·¦ä¸‹ã¸ç§»å‹•ï¼ˆLå­—å‹å®Œæˆï¼‰
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[3] === 4 && puzzle[6] !== 7) {
                const pieceSevenIndex = puzzle.indexOf(7);
                currentSuperHint = {
                    from: pieceSevenIndex,
                    to: 6,
                    piece: 7,
                    step: 12
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="step-number">â‘¦</span>ã‚’<span class="target-position">å·¦ä¸‹</span>ã¸ç§»å‹•ã—ã¦ãã ã•ã„ï¼ˆLå­—å‹å®Œæˆï¼ï¼‰`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †2: â‘ ã®éš£ã«â‘¢ã‚’é…ç½®
            if (puzzle[1] !== 3) {
                const pieceThreeIndex = puzzle.indexOf(3);
                currentSuperHint = {
                    from: pieceThreeIndex,
                    to: 1,
                    piece: 3,
                    step: 2
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="step-number">â‘¢</span>ã‚’<span class="target-position">â‘ ã®éš£</span>ã«é…ç½®ã—ã¦ãã ã•ã„`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †3: â‘¢ã®çœŸä¸‹ã«â‘¡ã‚’é…ç½®
            if (puzzle[4] !== 2) {
                const pieceTwoIndex = puzzle.indexOf(2);
                currentSuperHint = {
                    from: pieceTwoIndex,
                    to: 4,
                    piece: 2,
                    step: 3
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="step-number">â‘¡</span>ã‚’<span class="target-position">â‘¢ã®çœŸä¸‹</span>ã«é…ç½®ã—ã¦ãã ã•ã„`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †4: â‘¢ã®éš£ã‚’ç©ºç™½ã«ã™ã‚‹
            if (puzzle[2] !== 0) {
                const pieceAtPosition2 = puzzle[2];
                currentSuperHint = {
                    from: 2,
                    to: null,
                    piece: pieceAtPosition2,
                    step: 4
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="target-position">â‘¢ã®éš£</span>ã‚’<span class="step-number">ç©ºç™½</span>ã«ã—ã¦ãã ã•ã„`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †5: å³ä¸Šã®ç©ºç™½ã«â‘¢ã‚’ç§»å‹•
            if (puzzle[2] === 0 && puzzle[1] === 3) {
                const pieceThreeIndex = puzzle.indexOf(3);
                currentSuperHint = {
                    from: pieceThreeIndex,
                    to: 2,
                    piece: 3,
                    step: 5
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `ğŸ¯ <span class="step-number">â‘¢</span>ã‚’<span class="target-position">å³ä¸Šã®ç©ºç™½</span>ã«ç§»å‹•ã—ã¦ãã ã•ã„`;
                renderPuzzle();
                return;
            }
            
            // æ‰‹é †å®Œäº†å¾Œã¯é€šå¸¸ã®ãƒ’ãƒ³ãƒˆ
            document.getElementById('hintMessage').innerHTML = 'ãƒ‘ã‚ºãƒ«ã‚’è§£ã„ã¦ãã ã•ã„ï¼';
        }

        function applySuperHint() {
            if (!currentSuperHint) return;
            
            const puzzleContainer = document.getElementById('puzzleGrid');
            const tiles = puzzleContainer.children;
            
            // å„æ‰‹é †ã«å¿œã˜ãŸãƒã‚¤ãƒ©ã‚¤ãƒˆ
            if (currentSuperHint.step === 1) {
                // æ‰‹é †1: â‘ ã®ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€å·¦ä¸Šã‚’èµ¤æ 
                const pieceOneCurrentIndex = puzzle.indexOf(1);
                if (tiles[pieceOneCurrentIndex] && !tiles[pieceOneCurrentIndex].classList.contains('empty')) {
                    tiles[pieceOneCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[0]) {
                    tiles[0].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 2) {
                // æ‰‹é †2: â‘¢ã®ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€â‘ ã®éš£ï¼ˆä½ç½®1ï¼‰ã‚’èµ¤æ 
                const pieceThreeCurrentIndex = puzzle.indexOf(3);
                if (tiles[pieceThreeCurrentIndex] && !tiles[pieceThreeCurrentIndex].classList.contains('empty')) {
                    tiles[pieceThreeCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[1]) {
                    tiles[1].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 3) {
                // æ‰‹é †3: â‘¡ã®ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€â‘¢ã®çœŸä¸‹ï¼ˆä½ç½®4ï¼‰ã‚’èµ¤æ 
                const pieceTwoCurrentIndex = puzzle.indexOf(2);
                if (tiles[pieceTwoCurrentIndex] && !tiles[pieceTwoCurrentIndex].classList.contains('empty')) {
                    tiles[pieceTwoCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[4]) {
                    tiles[4].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 4) {
                // æ‰‹é †4: â‘¢ã®éš£ï¼ˆä½ç½®2ï¼‰ã«ã‚ã‚‹ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€ãã®ä½ç½®ã‚’èµ¤æ 
                if (tiles[2] && !tiles[2].classList.contains('empty')) {
                    tiles[2].classList.add('super-hint-piece');
                }
                if (tiles[2]) {
                    tiles[2].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 5) {
                // æ‰‹é †5: â‘¢ã®ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€å³ä¸Šï¼ˆä½ç½®2ï¼‰ã‚’èµ¤æ 
                const pieceThreeCurrentIndex = puzzle.indexOf(3);
                if (tiles[pieceThreeCurrentIndex] && !tiles[pieceThreeCurrentIndex].classList.contains('empty')) {
                    tiles[pieceThreeCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[2]) {
                    tiles[2].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 6) {
                // æ‰‹é †6: â‘¡ã®ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€ä¸Šæ®µï¼ˆä½ç½®1ï¼‰ã‚’èµ¤æ 
                const pieceTwoCurrentIndex = puzzle.indexOf(2);
                if (tiles[pieceTwoCurrentIndex] && !tiles[pieceTwoCurrentIndex].classList.contains('empty')) {
                    tiles[pieceTwoCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[1]) {
                    tiles[1].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 7) {
                // æ‰‹é †7: â‘£ã®ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€å·¦ä¸‹ï¼ˆä½ç½®6ï¼‰ã‚’èµ¤æ 
                const pieceFourCurrentIndex = puzzle.indexOf(4);
                if (tiles[pieceFourCurrentIndex] && !tiles[pieceFourCurrentIndex].classList.contains('empty')) {
                    tiles[pieceFourCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[6]) {
                    tiles[6].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 8) {
                // æ‰‹é †8: â‘¦ã®ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€å³ä¸‹ï¼ˆä½ç½®8ï¼‰ã‚’èµ¤æ 
                const pieceSevenCurrentIndex = puzzle.indexOf(7);
                if (tiles[pieceSevenCurrentIndex] && !tiles[pieceSevenCurrentIndex].classList.contains('empty')) {
                    tiles[pieceSevenCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[8]) {
                    tiles[8].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 9) {
                // æ‰‹é †9: â‘¦ã®ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€â‘£ã®å³å´ï¼ˆä½ç½®7ï¼‰ã‚’èµ¤æ 
                const pieceSevenCurrentIndex = puzzle.indexOf(7);
                if (tiles[pieceSevenCurrentIndex] && !tiles[pieceSevenCurrentIndex].classList.contains('empty')) {
                    tiles[pieceSevenCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[7]) {
                    tiles[7].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 10) {
                // æ‰‹é †10: â‘£ã®ä¸Šï¼ˆä½ç½®3ï¼‰ã«ã‚ã‚‹ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€ãã®ä½ç½®ã‚’èµ¤æ 
                if (tiles[3] && !tiles[3].classList.contains('empty')) {
                    tiles[3].classList.add('super-hint-piece');
                }
                if (tiles[3]) {
                    tiles[3].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 11) {
                // æ‰‹é †11: â‘£ã®ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€ä¸Šï¼ˆä½ç½®3ï¼‰ã‚’èµ¤æ 
                const pieceFourCurrentIndex = puzzle.indexOf(4);
                if (tiles[pieceFourCurrentIndex] && !tiles[pieceFourCurrentIndex].classList.contains('empty')) {
                    tiles[pieceFourCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[3]) {
                    tiles[3].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 12) {
                // æ‰‹é †12: â‘¦ã®ãƒ”ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã€å·¦ä¸‹ï¼ˆä½ç½®6ï¼‰ã‚’èµ¤æ 
                const pieceSevenCurrentIndex = puzzle.indexOf(7);
                if (tiles[pieceSevenCurrentIndex] && !tiles[pieceSevenCurrentIndex].classList.contains('empty')) {
                    tiles[pieceSevenCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[6]) {
                    tiles[6].classList.add('super-hint-target');
                }
            } else {
                // é€šå¸¸ã®ãƒ’ãƒ³ãƒˆ
                const targetPieceIndex = puzzle.indexOf(currentSuperHint.piece);
                if (tiles[targetPieceIndex] && !tiles[targetPieceIndex].classList.contains('empty')) {
                    tiles[targetPieceIndex].classList.add('super-hint-piece');
                }
                if (tiles[currentSuperHint.to]) {
                    tiles[currentSuperHint.to].classList.add('super-hint-target');
                }
            }
        }

        function checkSuperHintCompletion() {
            if (!superHintActive || !currentSuperHint) return;
            
            let stepCompleted = false;
            let completionMessage = '';
            
            if (currentSuperHint.step === 1 && puzzle[0] === 1) {
                stepCompleted = true;
                completionMessage = 'âœ… <strong style="color: #4CAF50;">â‘ ãŒå·¦ä¸Šã«é…ç½®ã•ã‚Œã¾ã—ãŸï¼</strong><br>æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else if (currentSuperHint.step === 2 && puzzle[1] === 3) {
                stepCompleted = true;
                completionMessage = 'âœ… <strong style="color: #4CAF50;">â‘¢ãŒâ‘ ã®éš£ã«é…ç½®ã•ã‚Œã¾ã—ãŸï¼</strong><br>æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else if (currentSuperHint.step === 3 && puzzle[4] === 2) {
                stepCompleted = true;
                completionMessage = 'âœ… <strong style="color: #4CAF50;">â‘¡ãŒâ‘¢ã®çœŸä¸‹ã«é…ç½®ã•ã‚Œã¾ã—ãŸï¼</strong><br>æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else if (currentSuperHint.step === 4 && puzzle[2] === 0) {
                stepCompleted = true;
                completionMessage = 'âœ… <strong style="color: #4CAF50;">â‘¢ã®éš£ãŒç©ºç™½ã«ãªã‚Šã¾ã—ãŸï¼</strong><br>æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else if (currentSuperHint.step === 5 && puzzle[2] === 3) {
                stepCompleted = true;
                completionMessage = 'âœ… <strong style="color: #4CAF50;">â‘¢ãŒå³ä¸Šã«ç§»å‹•ã—ã¾ã—ãŸï¼</strong><br>æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else if (currentSuperHint.step === 6 && puzzle[1] === 2 && puzzle[0] === 1 && puzzle[2] === 3) {
                stepCompleted = true;
                completionMessage = 'ğŸ‰ <strong style="color: #FF6B9D; font-size: 1.1em;">â‘¡ã‚’ä¸Šæ®µã«ç§»å‹•ã—ã¾ã—ãŸï¼ä¸Šæ®µãŒå®Œæˆã—ã¾ã—ãŸï¼</strong><br><span style="color: #666;">ä¸Šæ®µã¯ã‚‚ã†å‹•ã‹ã—ã¾ã›ã‚“ã€‚æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span>';
            } else if (currentSuperHint.step === 7 && puzzle[6] === 4) {
                stepCompleted = true;
                completionMessage = 'âœ… <strong style="color: #4CAF50;">â‘£ã‚’å·¦ä¸‹ã«ç§»å‹•ã—ã¾ã—ãŸï¼</strong><br>æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else if (currentSuperHint.step === 8 && puzzle[8] === 7) {
                stepCompleted = true;
                completionMessage = 'âœ… <strong style="color: #4CAF50;">â‘¦ã‚’å³ä¸‹ã«ç§»å‹•ã—ã¾ã—ãŸï¼</strong><br>æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else if (currentSuperHint.step === 9 && puzzle[7] === 7) {
                stepCompleted = true;
                completionMessage = 'âœ… <strong style="color: #4CAF50;">â‘¦ã‚’â‘£ã®å³å´ã«ç§»å‹•ã—ã¾ã—ãŸï¼</strong><br>æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else if (currentSuperHint.step === 10 && puzzle[3] === 0) {
                stepCompleted = true;
                completionMessage = 'âœ… <strong style="color: #4CAF50;">â‘£ã®ä¸ŠãŒç©ºç™½ã«ãªã‚Šã¾ã—ãŸï¼</strong><br>æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else if (currentSuperHint.step === 11 && puzzle[3] === 4) {
                stepCompleted = true;
                completionMessage = 'âœ… <strong style="color: #4CAF50;">â‘£ã‚’ä¸Šã«ç§»å‹•ã—ã¾ã—ãŸï¼</strong><br>æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else if (currentSuperHint.step === 12 && puzzle[6] === 7 && puzzle[3] === 4) {
                stepCompleted = true;
                completionMessage = 'ğŸ‰ <strong style="color: #FF6B9D; font-size: 1.1em;">â‘¦ã‚’å·¦ä¸‹ã«ç§»å‹•ã—ã¾ã—ãŸï¼Lå­—å‹ãŒå®Œæˆã—ã¾ã—ãŸï¼</strong><br><span style="color: #666;">â‘£ã¨â‘¦ã¯ã‚‚ã†å‹•ã‹ã—ã¾ã›ã‚“ã€‚æ¬¡ã®è¶…ãƒ’ãƒ³ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span>';
            }
            
            if (stepCompleted) {
                clearSuperHint();
                document.getElementById('hintMessage').innerHTML = completionMessage;
            }
        }

        function clearSuperHint() {
            superHintActive = false;
            currentSuperHint = null;
            
            // ã™ã¹ã¦ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
            document.querySelectorAll('.puzzle-piece').forEach(tile => {
                tile.classList.remove('super-hint-piece', 'super-hint-target');
            });
            
            document.getElementById('hintMessage').innerHTML = 
                'ã€Œè¶…ãƒ’ãƒ³ãƒˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æ¬¡ã«é…ç½®ã™ã¹ããƒ”ãƒ¼ã‚¹ã¨ä½ç½®ã‚’æ•™ãˆã¾ã™ï¼';
        }

        function shufflePuzzle() {
            stopGame();
            hintUsedThisRound = false;
            clearSuperHint();
            
            const pieces = [1, 2, 3, 4, 5, 6, 7, 8, 0]; // æ–°ã—ã„ç•ªå·ä½“ç³»
            
            for (let i = pieces.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pieces[i], pieces[j]] = [pieces[j], pieces[i]];
            }
            
            puzzle = pieces;
            emptyPos = puzzle.indexOf(0);
            
            if (!isSolvable(puzzle)) {
                let firstNonEmpty = -1, secondNonEmpty = -1;
                for (let i = 0; i < 9; i++) {
                    if (puzzle[i] !== 0) {
                        if (firstNonEmpty === -1) {
                            firstNonEmpty = i;
                        } else if (secondNonEmpty === -1) {
                            secondNonEmpty = i;
                            break;
                        }
                    }
                }
                if (firstNonEmpty !== -1 && secondNonEmpty !== -1) {
                    [puzzle[firstNonEmpty], puzzle[secondNonEmpty]] = [puzzle[secondNonEmpty], puzzle[firstNonEmpty]];
                }
            }
            
            renderPuzzle();
            document.getElementById('victoryMessage').style.display = 'none';
        }
        
        function isSolvable(arr) {
            let inversions = 0;
            
            for (let i = 0; i < 9; i++) {
                if (arr[i] === 0) continue;
                for (let j = i + 1; j < 9; j++) {
                    if (arr[j] === 0) continue;
                    if (arr[i] > arr[j]) {
                        inversions++;
                    }
                }
            }
            
            return inversions % 2 === 0;
        }

        function resetPuzzle() {
            stopGame();
            puzzle = [1, 2, 3, 4, 5, 6, 7, 8, 0];
            emptyPos = 8;
            clearSuperHint();
            renderPuzzle();
            document.getElementById('victoryMessage').style.display = 'none';
        }

        function toggleHint() {
            showHints = !showHints;
            const hintButton = document.getElementById('hintButton');
            
            if (showHints) {
                hintButton.textContent = 'ãƒ’ãƒ³ãƒˆ OFF';
                hintButton.classList.add('active');
                hintUsedThisRound = true;
            } else {
                hintButton.textContent = 'ãƒ’ãƒ³ãƒˆ';
                hintButton.classList.remove('active');
            }
            
            const hintNumbers = document.querySelectorAll('.hint-number');
            hintNumbers.forEach(hint => {
                if (showHints) {
                    hint.style.opacity = '1';
                } else {
                    hint.style.opacity = '0';
                }
            });
        }

        function startGame() {
            if (isGameActive) return;
            isGameActive = true;
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopGame() {
            isGameActive = false;
            if (timerInterval) { 
                clearInterval(timerInterval); 
                timerInterval = null; 
            }
            moveCount = 0;
            document.getElementById('moveCount').textContent = '0';
            document.getElementById('timeCount').textContent = '00:00';
        }

        function endGame() {
            isGameActive = false;
            if (timerInterval) { 
                clearInterval(timerInterval); 
                timerInterval = null; 
            }
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const isNewRecord = !bestTime || elapsed < bestTime;
            
            if (isNewRecord) {
                bestTime = elapsed;
                updateBestTimeDisplay();
            }
            
            showVictoryMessage(elapsed, isNewRecord);
        }

        function getTimeMessage(seconds) {
            const messages = {
                ç¥: [
                    "ğŸ‘‘ ç¥ãƒ¬ãƒ™ãƒ«ï¼ã‚ãªãŸã¯ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ã‚ºãƒ«ã®ç¥ã§ã™ï¼",
                    "ğŸ”¥ äººé–“ã‚’è¶…è¶Šã—ãŸé€Ÿã•ï¼ä¼èª¬ã®è¨˜éŒ²ï¼",
                    "âœ¨ ç¥æ¥­ï¼æ¨ªç¶±ã‚‚è„±å¸½ã§ã™ï¼"
                ],
                æ¨ªç¶±: [
                    "ğŸ¥‡ æ¨ªç¶±ãƒ¬ãƒ™ãƒ«ï¼ãƒ—ãƒ­ç´šã®å®ŸåŠ›ã§ã™ï¼",
                    "âš¡ è¶…äººçš„ãªé€Ÿã•ï¼é ­è„³æ˜æ™°ã®è¨¼æ‹ ï¼",
                    "ğŸ¯ å®Œç’§ãªåˆ¤æ–­åŠ›ï¼è¦‹äº‹ã§ã™ï¼"
                ],
                ãƒ—ãƒ­: [
                    "âš¡ 30ç§’åˆ‡ã‚Šï¼ãƒ—ãƒ­ç´šã®é€Ÿã•ã§ã™ï¼",
                    "ğŸŠ å®ŸåŠ›è€…ã®è¨¼æ˜ï¼è¦‹äº‹ãªæ‰‹è…•ï¼",
                    "ğŸŒŸ å®‰å®šã—ãŸé«˜é€Ÿè§£ç­”ï¼æµçŸ³ã§ã™ï¼"
                ],
                ä¸Šç´šè€…: [
                    "ğŸš€ 20ç§’å°çªå…¥ï¼è„³ã®å›è»¢ãŒè¶…é«˜é€Ÿï¼",
                    "ğŸ’¨ é©šç•°çš„ãªã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ç´ æ™´ã‚‰ã—ã„ï¼",
                    "â­ ä¸Šç´šè€…ã®é ˜åŸŸï¼ãã®èª¿å­ï¼"
                ],
                æœ¬ç•ª: [
                    "ğŸŒ¸ æœ¬ç•ªãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ï¼åˆ¶é™æ™‚é–“å†…é”æˆï¼",
                    "ğŸ’ª 40ç§’å°ï¼ç´ æ™´ã‚‰ã—ã„å®ŸåŠ›ã§ã™ã­ï¼",
                    "ğŸ“ˆ é †èª¿ãªãƒšãƒ¼ã‚¹ï¼ç€å®Ÿã«ä¸Šé”ä¸­ï¼"
                ],
                ä¸€åˆ†åˆ‡ã‚Š: [
                    "ğŸ‘ 1åˆ†åˆ‡ã‚Šé”æˆï¼ç«‹æ´¾ãªå®ŸåŠ›ã§ã™ï¼",
                    "ğŸ‰ 50ç§’å°ï¼é›†ä¸­åŠ›ãŒç´ æ™´ã‚‰ã—ã„ï¼",
                    "âœ¨ 1åˆ†ä»¥å†…ã‚¯ãƒªã‚¢ï¼é ­è„³æ˜æ™°ã§ã™ã­ï¼"
                ],
                é”æˆ: [
                    "ğŸŠ å®ŒæˆãŠã‚ã§ã¨ã†ï¼ã‚ãªãŸã«ã¯ã§ãã‚‹åŠ›ãŒã‚ã‚‹ï¼",
                    "ğŸ† è«¦ã‚ãšã«æœ€å¾Œã¾ã§ï¼ãã®å§¿å‹¢ãŒä¸€ç•ªå¤§åˆ‡ï¼",
                    "âœ¨ å®Œæˆã®ç¬é–“ã“ããŒæœ€é«˜ã®å®ç‰©ï¼ç´ æ™´ã‚‰ã—ã„ï¼",
                    "ğŸŒˆ ã§ããŸï¼ã“ã®é”æˆæ„Ÿã‚’å¿˜ã‚Œãªã„ã§ï¼",
                    "ğŸŒŸ ã‚„ã‚Œã°ã§ãã‚‹ï¼è‡ªåˆ†ã‚’ä¿¡ã˜ãŸçµæœã§ã™ï¼",
                    "ğŸ’ª å®Œæˆã¨ã„ã†æˆåŠŸä½“é¨“ãŒã‚ãªãŸã®è²¡ç”£ï¼",
                    "ğŸ¯ æœ€å¾Œã¾ã§é ‘å¼µã£ãŸã‚ãªãŸãŒä¸€ç•ªè¼ã„ã¦ã‚‹ï¼"
                ]
            };

            let category, title;
            if (seconds < 10) {
                category = "ç¥";
                title = "ç¥ãƒ¬ãƒ™ãƒ«";
            } else if (seconds < 20) {
                category = "æ¨ªç¶±";
                title = "æ¨ªç¶±ãƒ¬ãƒ™ãƒ«";
            } else if (seconds < 30) {
                category = "ãƒ—ãƒ­";
                title = "ãƒ—ãƒ­ç´š";
            } else if (seconds < 40) {
                category = "ä¸Šç´šè€…";
                title = "ä¸Šç´šè€…ãƒ¬ãƒ™ãƒ«";
            } else if (seconds < 50) {
                category = "æœ¬ç•ª";
                title = "æœ¬ç•ªãƒ¬ãƒ™ãƒ«";
            } else if (seconds < 60) {
                category = "ä¸€åˆ†åˆ‡ã‚Š";
                title = "1åˆ†åˆ‡ã‚Šãƒ¬ãƒ™ãƒ«";
            } else {
                category = "é”æˆ";
                title = "é”æˆãƒ¬ãƒ™ãƒ«";
            }

            const messageList = messages[category];
            const randomMessage = messageList[Math.floor(Math.random() * messageList.length)];
            
            return { title, message: randomMessage };
        }

        function updateBestTimeDisplay() {
            if (bestTime) {
                const minutes = Math.floor(bestTime / 60);
                const seconds = bestTime % 60;
                const timeStr = minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${seconds}s`;
                document.getElementById('bestTimeDisplay').textContent = timeStr;
            }
        }

        function showVictoryMessage(time, isNewRecord) {
            const { title, message } = getTimeMessage(time);
            const minutes = Math.floor(time / 60);
            const seconds = time % 60;
            const timeStr = minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${seconds}ç§’`;
            
            const popupHtml = `
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">
                    ${isNewRecord ? 'ğŸ‰ ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ æ›´æ–°ï¼' : 'ğŸ“Š ã‚¯ãƒªã‚¢ï¼'}
                </div>
                <div style="font-size: 16px; margin-bottom: 10px;">
                    â° ${timeStr} - ${title}
                </div>
                <div style="font-size: 14px; margin-bottom: 15px;">
                    ğŸ¯ ${moveCount}æ‰‹
                </div>
                <div style="font-size: 15px; line-height: 1.4; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">
                    ${message}
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="closeVictoryMessage()" style="background: white; color: #4CAF50; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold;">ç¶šã‘ã‚‹</button>
                </div>
            `;

            document.getElementById('victoryPopup').innerHTML = popupHtml;
            document.getElementById('victoryOverlay').style.display = 'flex';
        }

        function closeVictoryMessage() {
            document.getElementById('victoryOverlay').style.display = 'none';
        }

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', function(e) {
            if (e.target.id === 'victoryOverlay') {
                closeVictoryMessage();
            }
        });

        function updateTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timeCount').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function checkWin() {
            for (let i = 0; i < 8; i++) {
                if (puzzle[i] !== i + 1) return false; // æ–°ã—ã„ç•ªå·ä½“ç³»: 1,2,3,4,5,6,7,8
            }
            return puzzle[8] === 0; // æœ€å¾Œã¯ç©ºç™½
        }

        // ã‚¹ãƒãƒ›ã§ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ã¨é«˜é€Ÿã‚¿ãƒƒãƒå¯¾å¿œï¼ˆAndroidå¼·åŒ–ï¼‰
        let touchCount = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchCount++;
            
            // ãƒãƒ«ãƒã‚¿ãƒƒãƒã‚’é˜²æ­¢
            if (e.touches.length > 1) {
                e.preventDefault();
                return false;
            }
            
            // Android Chromeã®é…å»¶å¯¾å¿œ
            if (touchCount === 1) {
                setTimeout(() => {
                    touchCount = 0;
                }, 500);
            }
        }, { passive: false });

        // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—é˜²æ­¢ã‚’ã‚ˆã‚ŠåŠ¹æœçš„ã«ï¼ˆAndroidå¯¾å¿œï¼‰
        let lastTouchEnd = 0;
        let preventDoubleTap = false;
        
        document.addEventListener('touchend', function(e) {
            const now = Date.now();
            
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
                preventDoubleTap = true;
                setTimeout(() => {
                    preventDoubleTap = false;
                }, 400);
                return false;
            }
            
            if (preventDoubleTap) {
                e.preventDefault();
                return false;
            }
            
            lastTouchEnd = now;
        }, { passive: false });
        
        // Android Chromeç‰¹æœ‰ã®å•é¡Œå¯¾å¿œ
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        // iOS Safariã§ã®300msãƒ‡ã‚£ãƒ¬ã‚¤ã‚’å®Œå…¨ã«é™¤å»
        document.addEventListener('touchstart', function() {}, { passive: true });
    </script>
</body>
</html>
