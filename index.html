<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- より確実なビューポート設定 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <!-- iOS Safari対応 -->
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>さくやちゃん スライドパズル</title>
    
    <!-- PWA設定 -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuOBleOBj+OChuOBoeOCg+OCkyDjgrnjg6njgqTjg4njg5Hjgrrjg6siLAogICJzaG9ydF9uYW1lIjogIuOCueODqeOCpOODieODkeOCuuODqyIsCiAgImRlc2NyaXB0aW9uIjogIjPDlzMg44K544Op44Kk44OJ44OR44K644Or44Ky44O844OgIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmIiwKICAidGhlbWVfY29sb3IiOiAiI2ZmNmI5ZCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBSEFBQUFCd0NBTUFBQUI4QUFBQUFBQUFBWE5TUjBJQXJzNGM2UUFBQUFSblFVMUJBQUN4and2OFlRVUFBQUFKY0VoWmN3QUFHZEFBQUJUV0FSalJ5dTBBQUFBTUVsRVFWUjQybU5rWUhYWUFBQUFBRWxGVGtTdVFtQ0MiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
    
    <style>
        /* リセットCSS追加 */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            /* フォントサイズの自動調整を防ぐ */
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            /* 高さを確実に制御 */
            height: 100%;
            overflow-x: hidden;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            min-height: 100vh;
            /* より確実な高さ制御 */
            height: auto;
            margin: 0; 
            padding: 5px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%); 
            /* タッチ操作とスクロール制御 */
            touch-action: manipulation;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -ms-touch-action: manipulation;
            overscroll-behavior: contain;
            /* ズーム防止を強化 */
            overflow-x: hidden;
            position: relative;
            width: 100%;
        }
        
        .game-container {
            background: white; 
            border-radius: 20px; 
            padding: 10px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            text-align: center; 
            /* より安全なサイズ制御 */
            max-width: calc(100vw - 20px);
            max-width: calc(100% - 20px);
            width: 100%;
            /* 高さの制御 */
            max-height: calc(100vh - 20px);
            overflow: visible;
            position: relative;
        }
        
        h1 {
            color: #ff6b9d; 
            margin: 5px 0; 
            /* より安全なフォントサイズ */
            font-size: min(6vw, 32px);
            line-height: 1.2;
        }
        
        .subtitle {
            display: none;
        }
        
        .top-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
            gap: 8px;
        }
        
        .reference-image {
            /* より確実なサイズ制御 */
            width: min(100px, 25vw, 100px); 
            height: min(100px, 25vw, 100px); 
            border-radius: 8px; 
            border: 2px solid #ff6b9d;
            flex-shrink: 0;
        }
        
        .stats {
            display: flex; 
            justify-content: center;
            gap: min(15px, 4vw);
            width: 100%;
            flex-wrap: wrap;
        }
        
        .stat {
            background: #f8f9ff; 
            padding: 6px 10px; 
            border-radius: 10px;
            text-align: center;
            min-width: 50px;
            flex-shrink: 0;
        }
        
        .stat-number {
            font-size: min(5vw, 18px); 
            font-weight: bold; 
            color: #ff6b9d;
            line-height: 1.2;
        }
        
        .stat-label {
            font-size: min(3vw, 11px); 
            color: #666; 
            margin-top: 2px;
            line-height: 1.2;
        }
        
        .puzzle-container {
            display: inline-block; 
            border: 4px solid #ff6b9d; 
            border-radius: 15px; 
            background: #f8f8f8; 
            padding: 6px; 
            margin: 8px 0;
            /* サイズオーバーフロー防止 */
            max-width: 100%;
            overflow: visible;
        }
        
        .puzzle-grid {
            display: grid; 
            grid-template-columns: repeat(3, var(--piece-size)); 
            grid-template-rows: repeat(3, var(--piece-size)); 
            gap: 2px; 
            background: #ddd; 
            padding: 2px; 
            border-radius: 10px;
            /* より安全なピースサイズ計算 */
            --piece-size: min(
                min(140px, calc((100vw - 80px) / 3)), 
                min(140px, calc((100% - 60px) / 3)),
                140px
            );
            /* グリッドの最大サイズ制限 */
            max-width: calc(100vw - 60px);
            width: fit-content;
            margin: 0 auto;
        }
        
        .puzzle-piece {
            background-size: calc(var(--piece-size) * 3) calc(var(--piece-size) * 3); 
            border: 2px solid #fff; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: transform 0.1s ease, box-shadow 0.1s ease; 
            position: relative; 
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -ms-touch-action: manipulation;
            user-select: none;
            width: var(--piece-size);
            height: var(--piece-size);
            /* GPU加速とパフォーマンス向上 */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            will-change: transform;
            /* サイズ固定を強化 */
            min-width: var(--piece-size);
            min-height: var(--piece-size);
            max-width: var(--piece-size);
            max-height: var(--piece-size);
            flex-shrink: 0;
        }
        
        .puzzle-piece:hover, .puzzle-piece:active {
            transform: scale(1.03); 
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }
        
        .puzzle-piece:active {
            transform: scale(0.98);
            transition: transform 0.05s ease;
        }
        
        .puzzle-piece.empty {
            background: #f0f0f0 !important; 
            border: 2px dashed #ccc; 
            cursor: default;
        }
        
        .puzzle-piece.empty:hover, .puzzle-piece.empty:active {
            transform: none; 
            box-shadow: none;
        }
        
        .puzzle-piece.locked {
            opacity: 0.7;
            cursor: not-allowed !important;
            background-color: #c0c0c0 !important;
        }
        
        .puzzle-piece.locked:hover, .puzzle-piece.locked:active {
            transform: none !important;
            box-shadow: none !important;
        }
        
        .puzzle-piece.super-hint-piece {
            animation: pulse 1s infinite;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.8) !important;
            position: relative;
        }
        
        .puzzle-piece.super-hint-piece::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, rgba(255, 68, 68, 0.5), rgba(204, 0, 0, 0.5));
            border-radius: 6px;
            pointer-events: none;
        }
        
        .puzzle-piece.super-hint-target {
            border: 4px solid #ff4444 !important;
            animation: borderGlow 1s infinite alternate;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.8) !important;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes borderGlow {
            0% { border-color: #ff4444; box-shadow: 0 0 15px rgba(255, 68, 68, 0.8); }
            100% { border-color: #ff0000; box-shadow: 0 0 25px rgba(255, 0, 0, 1); }
        }
        
        .hint-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: min(7vw, 28px);
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            line-height: 1;
        }
        
        .controls {
            margin: 10px 0;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 0 5px;
        }
        
        button {
            background: linear-gradient(45deg, #ff6b9d, #ff8fab); 
            color: white; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: min(4vw, 13px); 
            font-weight: bold; 
            transition: transform 0.1s ease, box-shadow 0.1s ease; 
            box-shadow: 0 4px 15px rgba(255,107,157,0.3);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            /* より確実なタッチ対応 */
            min-height: 40px;
            min-width: 70px;
            line-height: 1.2;
            flex-shrink: 0;
        }
        
        button:hover, button:active {
            transform: translateY(-1px); 
            box-shadow: 0 5px 18px rgba(255,107,157,0.4);
        }
        
        button:active {
            transform: translateY(0px) scale(0.98);
            transition: transform 0.05s ease;
        }
        
        .hint-button {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
        }
        
        .hint-button.active {
            background: linear-gradient(45deg, #FF9800, #FFC107);
        }
        
        .super-hint-button {
            background: linear-gradient(45deg, #ff4444, #ff6666);
            animation: rainbow 2s infinite;
            font-weight: bold;
        }
        
        @keyframes rainbow {
            0% { background: linear-gradient(45deg, #ff4444, #ff6666); }
            33% { background: linear-gradient(45deg, #4CAF50, #8BC34A); }
            66% { background: linear-gradient(45deg, #2196F3, #64B5F6); }
            100% { background: linear-gradient(45deg, #ff4444, #ff6666); }
        }
        
        .hint-message {
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
            border: 3px solid #ff6b9d;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 5px;
            font-size: min(4.5vw, 16px);
            font-weight: bold;
            color: #2c3e50;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.2);
            line-height: 1.4;
            /* オーバーフロー防止 */
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: calc(100vw - 30px);
        }
        
        .hint-message .step-number {
            color: #ff4444;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(255, 68, 68, 0.3);
        }
        
        .hint-message .target-position {
            color: #4CAF50;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(76, 175, 80, 0.3);
        }
        
        .victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .victory-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(300px, 80vw);
            height: min(300px, 80vw);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: min(350px, 70vw);
            animation: circleAppear 0.5s ease-in-out;
        }
        
        .victory-popup {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            max-width: calc(100vw - 20px);
            min-width: min(280px, calc(100vw - 40px));
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: popupSlide 0.5s ease-in-out 0.3s both;
            font-size: min(4vw, 14px);
            line-height: 1.4;
        }
        
        @keyframes circleAppear {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        @keyframes popupSlide {
            0% { transform: translateX(-50%) translateY(100px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .victory-message {
            display: none;
        }
        
        @keyframes celebrate {
            0% { transform: scale(0.8); opacity: 0; } 
            50% { transform: scale(1.1); } 
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* より具体的なレスポンシブ対応 */
        @media screen and (max-width: 480px) {
            .game-container {
                padding: 8px;
                margin: 2px;
                border-radius: 15px;
            }
            
            .puzzle-container {
                padding: 4px;
                margin: 6px 0;
            }
            
            .puzzle-grid {
                --piece-size: min(
                    calc((100vw - 70px) / 3), 
                    calc((100% - 50px) / 3),
                    120px
                );
                gap: 1px;
                padding: 1px;
            }
            
            .controls {
                margin: 8px 0;
                gap: 6px;
            }
            
            button {
                padding: 8px 12px;
                margin: 2px;
                font-size: min(3.5vw, 12px);
                min-height: 36px;
                min-width: 60px;
            }
            
            .hint-message {
                padding: 12px;
                font-size: min(4vw, 14px);
                margin: 8px 2px;
            }
            
            h1 {
                font-size: min(5vw, 24px);
            }
            
            .reference-image {
                width: min(80px, 20vw); 
                height: min(80px, 20vw); 
            }
        }
        
        @media screen and (max-width: 360px) {
            .puzzle-grid {
                --piece-size: min(
                    calc((100vw - 60px) / 3), 
                    calc((100% - 40px) / 3),
                    100px
                );
            }
            
            .game-container {
                padding: 6px;
            }
            
            button {
                font-size: min(3vw, 11px);
                padding: 6px 10px;
                min-height: 32px;
                min-width: 55px;
            }
            
            .hint-message {
                font-size: min(3.5vw, 13px);
                padding: 10px;
            }
        }
        
        @media screen and (max-width: 320px) {
            .puzzle-grid {
                --piece-size: min(
                    calc((100vw - 50px) / 3), 
                    calc((100% - 30px) / 3),
                    90px
                );
            }
        }
        
        /* 横向き対応 - サイドボタン配置 */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            body {
                padding: 2px;
                overflow: hidden;
            }
            
            .game-container {
                padding: 5px;
                max-height: calc(100vh - 10px);
                display: flex;
                flex-direction: column;
                position: relative;
            }
            
            .landscape-container {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                flex: 1;
                gap: 10px;
            }
            
            .landscape-left-controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
                min-width: 80px;
                align-items: center;
            }
            
            .landscape-right-controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
                min-width: 80px;
                align-items: center;
            }
            
            .landscape-center-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                flex: 1;
                max-width: 500px;
            }
            
            .top-section {
                margin-bottom: 3px;
                gap: 3px;
                flex-direction: row;
                justify-content: center;
                align-items: center;
            }
            
            .reference-image {
                width: min(50px, 10vw); 
                height: min(50px, 10vw); 
                margin-right: 10px;
            }
            
            .stats {
                gap: 8px;
            }
            
            .stat {
                padding: 4px 8px;
                min-width: 40px;
            }
            
            .stat-number {
                font-size: min(4vw, 14px);
            }
            
            .stat-label {
                font-size: min(2.5vw, 9px);
            }
            
            .puzzle-container {
                margin: 3px 0;
            }
            
            .puzzle-grid {
                --piece-size: min(
                    calc((100vh - 100px) / 3), 
                    calc((60vw) / 3),
                    120px
                );
            }
            
            .controls {
                display: none; /* 通常のコントロールを非表示 */
            }
            
            .hint-message {
                padding: 6px;
                margin: 3px 2px;
                min-height: 30px;
                font-size: min(3vw, 12px);
                max-width: 90%;
            }
            
            /* サイドボタンのスタイル */
            .landscape-left-controls button,
            .landscape-right-controls button {
                writing-mode: vertical-rl;
                text-orientation: mixed;
                width: 60px;
                height: 80px;
                padding: 8px 4px;
                font-size: min(3vw, 11px);
                border-radius: 15px;
                min-height: 80px;
                min-width: 60px;
                display: flex;
                align-items: center;
                justify-content: center;
                line-height: 1.1;
                word-break: keep-all;
            }
            
            h1 {
                font-size: min(4vw, 20px);
                margin: 2px 0;
            }
        }
        
        /* 横向きレイアウト用のコンテナ（通常時は非表示） */
        .landscape-container {
            display: none;
        }
        
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .landscape-container {
                display: flex;
            }
            
            .top-section,
            .puzzle-container,
            .hint-message {
                /* これらの要素は landscape-center-content に移動 */
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>🌸 スライドパズル 🌸</h1>
        <p class="subtitle">3×3 スライドパズル</p>
        
        <!-- 通常表示（縦向き） -->
        <div class="portrait-layout">
            <div class="top-section">
                <canvas id="referenceImage" class="reference-image" width="120" height="120"></canvas>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-number" id="moveCount">0</div>
                        <div class="stat-label">手数</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="timeCount">00:00</div>
                        <div class="stat-label">時間</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="bestTimeDisplay">--</div>
                        <div class="stat-label">ベスト</div>
                    </div>
                </div>
            </div>
            
            <div class="puzzle-container">
                <div class="puzzle-grid" id="puzzleGrid"></div>
            </div>
            
            <div id="hintMessage" class="hint-message">
                「超ヒント」ボタンを押すと、次に配置すべきピースと位置を教えます！
            </div>
            
            <div class="controls">
                <button onclick="shufflePuzzle()">シャッフル</button>
                <button onclick="toggleHint()" class="hint-button" id="hintButton">ヒント</button>
                <button onclick="showSuperHint()" class="super-hint-button" id="superHintButton">✨ 超ヒント</button>
            </div>
        </div>
        
        <!-- 横向き表示用レイアウト -->
        <div class="landscape-container">
            <div class="landscape-left-controls">
                <button onclick="shufflePuzzle()" style="background: linear-gradient(45deg, #ff6b9d, #ff8fab);">シャッフル</button>
                <button onclick="toggleHint()" class="hint-button" id="hintButtonLandscape" style="background: linear-gradient(45deg, #4CAF50, #8BC34A);">ヒント</button>
            </div>
            
            <div class="landscape-center-content">
                <div class="top-section">
                    <canvas id="referenceImageLandscape" class="reference-image" width="120" height="120"></canvas>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-number" id="moveCountLandscape">0</div>
                            <div class="stat-label">手数</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number" id="timeCountLandscape">00:00</div>
                            <div class="stat-label">時間</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number" id="bestTimeDisplayLandscape">--</div>
                            <div class="stat-label">ベスト</div>
                        </div>
                    </div>
                </div>
                
                <div class="puzzle-container">
                    <div class="puzzle-grid" id="puzzleGridLandscape"></div>
                </div>
                
                <div id="hintMessageLandscape" class="hint-message">
                    「超ヒント」ボタンを押すと、次に配置すべきピースと位置を教えます！
                </div>
            </div>
            
            <div class="landscape-right-controls">
                <button onclick="showSuperHint()" class="super-hint-button" id="superHintButtonLandscape" style="background: linear-gradient(45deg, #ff4444, #ff6666); animation: rainbow 2s infinite;">✨ 超ヒント</button>
            </div>
        </div>
        
        <div class="victory-overlay" id="victoryOverlay">
            <div class="victory-circle">⭕</div>
            <div class="victory-popup" id="victoryPopup"></div>
        </div>
        
        <div class="victory-message" id="victoryMessage">
            🎉 おめでとうございます！パズル完成です！ 🎉
        </div>
    </div>
    
    <script>
        // デフォルト画像（グラデーション）を作成
        function createDefaultImage() {
            const canvas = document.createElement('canvas');
            canvas.width = 360;
            canvas.height = 360;
            const ctx = canvas.getContext('2d');
            
            const gradient = ctx.createLinearGradient(0, 0, 360, 360);
            gradient.addColorStop(0, '#ff9a9e');
            gradient.addColorStop(0.5, '#fad0c4');
            gradient.addColorStop(1, '#a18cd1');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 360, 360);
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            for (let i = 0; i < 9; i++) {
                const x = (i % 3) * 120 + 20;
                const y = Math.floor(i / 3) * 120 + 20;
                ctx.beginPath();
                ctx.arc(x + 40, y + 40, 30, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText((i + 1).toString(), x + 40, y + 40);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            }
            
            return canvas.toDataURL();
        }

        //--- パズル用変数 ---
        let puzzle = [];
        let emptyPos = 8;
        let moveCount = 0;
        let startTime = null;
        let timerInterval = null;
        let isGameActive = false;
        let imageData = null;
        let showHints = false;
        let bestTime = null;
        let hintUsedThisRound = false;

        // 超ヒント機能用変数
        let currentSuperHint = null;
        let superHintActive = false;

        //--- 画像選択せずにデフォルト画像で開始 ---
        window.onload = function() {
            // PWA Service Worker登録
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdzbGlkZS1wdXp6bGUtdjEnOwpjb25zdCB1cmxzVG9DYWNoZSA9IFsKICAnLi8nLAogICcuL2luZGV4Lmh0bWwnCl07CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCBldmVudCA9PiB7CiAgZXZlbnQud2FpdFVudGlsKAogICAgY2FjaGVzLm9wZW4oQ0FDSEVfTkFNRSkKICAgICAgLnRoZW4oY2FjaGUgPT4gewogICAgICAgIHJldHVybiBjYWNoZS5hZGRBbGwodXJsc1RvQ2FjaGUpOwogICAgICB9KQogICk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsKICBldmVudC5yZXNwb25kV2l0aCgKICAgIGNhY2hlcy5tYXRjaChldmVudC5yZXF1ZXN0KQogICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlIHx8IGZldGNoKGV2ZW50LnJlcXVlc3QpOwogICAgICB9KQogICk7Cn0pOw==')
                .then(() => console.log('PWA Service Worker registered'))
                .catch(err => console.log('PWA Service Worker registration failed'));
            }

            imageData = 'sakuya.png';
            console.log('Loading sakuya.png...');
            
            // 画像読み込みエラー時のフォールバック
            const testImg = new Image();
            testImg.onerror = function() {
                console.log('画像読み込みエラー、デフォルト画像を使用');
                imageData = createDefaultImage();
                setTimeout(() => {
                    initializePuzzle();
                    updatePuzzleGridSize();
                }, 100);
            };
            testImg.onload = function() {
                console.log('画像読み込み成功！');
                setTimeout(() => {
                    initializePuzzle();
                    updatePuzzleGridSize();
                }, 200);
            };
            testImg.src = imageData;
        }

        // 画面サイズ変更時の調整
        window.addEventListener('resize', updatePuzzleGridSize);
        window.addEventListener('orientationchange', handleOrientationChange);

        function handleOrientationChange() {
            setTimeout(() => {
                updatePuzzleGridSize();
                updateLandscapeLayout();
            }, 100);
        }

        function updateLandscapeLayout() {
            const isLandscape = window.innerHeight < 500 && window.innerWidth > window.innerHeight;
            
            if (isLandscape) {
                // 横向きレイアウトに切り替え
                document.querySelector('.portrait-layout').style.display = 'none';
                document.querySelector('.landscape-container').style.display = 'flex';
                
                // データを横向きレイアウトに同期
                syncToLandscapeLayout();
            } else {
                // 縦向きレイアウトに戻る
                document.querySelector('.portrait-layout').style.display = 'block';
                document.querySelector('.landscape-container').style.display = 'none';
                
                // データを縦向きレイアウトに同期
                syncToPortraitLayout();
            }
        }

        function syncToLandscapeLayout() {
            // 統計情報を同期
            document.getElementById('moveCountLandscape').textContent = document.getElementById('moveCount').textContent;
            document.getElementById('timeCountLandscape').textContent = document.getElementById('timeCount').textContent;
            document.getElementById('bestTimeDisplayLandscape').textContent = document.getElementById('bestTimeDisplay').textContent;
            
            // ヒントメッセージを同期
            document.getElementById('hintMessageLandscape').innerHTML = document.getElementById('hintMessage').innerHTML;
            
            // ヒントボタンの状態を同期
            const hintButton = document.getElementById('hintButton');
            const hintButtonLandscape = document.getElementById('hintButtonLandscape');
            
            if (hintButton.classList.contains('active')) {
                hintButtonLandscape.classList.add('active');
                hintButtonLandscape.textContent = 'ヒント OFF';
                hintButtonLandscape.style.background = 'linear-gradient(45deg, #FF9800, #FFC107)';
            } else {
                hintButtonLandscape.classList.remove('active');
                hintButtonLandscape.textContent = 'ヒント';
                hintButtonLandscape.style.background = 'linear-gradient(45deg, #4CAF50, #8BC34A)';
            }
            
            // パズルグリッドを横向き用にコピー
            const originalGrid = document.getElementById('puzzleGrid');
            const landscapeGrid = document.getElementById('puzzleGridLandscape');
            landscapeGrid.innerHTML = originalGrid.innerHTML;
            
            // 参照画像も同期
            syncReferenceImage('referenceImageLandscape');
        }

        function syncToPortraitLayout() {
            // 統計情報を同期
            document.getElementById('moveCount').textContent = document.getElementById('moveCountLandscape').textContent;
            document.getElementById('timeCount').textContent = document.getElementById('timeCountLandscape').textContent;
            document.getElementById('bestTimeDisplay').textContent = document.getElementById('bestTimeDisplayLandscape').textContent;
            
            // ヒントメッセージを同期
            document.getElementById('hintMessage').innerHTML = document.getElementById('hintMessageLandscape').innerHTML;
        }

        function syncReferenceImage(targetId) {
            const sourceCanvas = document.getElementById('referenceImage');
            const targetCanvas = document.getElementById(targetId);
            const sourceCtx = sourceCanvas.getContext('2d');
            const targetCtx = targetCanvas.getContext('2d');
            
            // サイズを設定
            const size = Math.min(50, window.innerWidth * 0.1);
            targetCanvas.width = size;
            targetCanvas.height = size;
            targetCanvas.style.width = size + 'px';
            targetCanvas.style.height = size + 'px';
            
            // 画像をコピー
            targetCtx.drawImage(sourceCanvas, 0, 0, targetCanvas.width, targetCanvas.height);
        }

        function updatePuzzleGridSize() {
            const puzzleGrid = document.getElementById('puzzleGrid');
            const containerWidth = Math.min(window.innerWidth - 50, 500);
            const pieceSize = Math.min(140, (containerWidth - 30) / 3 - 6);
            
            puzzleGrid.style.setProperty('--piece-size', pieceSize + 'px');
            
            createReferenceImage();
            
            if (puzzle.length > 0) {
                renderPuzzle();
            }
        }

        function createReferenceImage() {
            const canvas = document.getElementById('referenceImage');
            const ctx = canvas.getContext('2d');
            
            const refSize = Math.min(100, window.innerWidth * 0.25);
            canvas.width = refSize;
            canvas.height = refSize;
            canvas.style.width = refSize + 'px';
            canvas.style.height = refSize + 'px';
            
            const img = new Image();
            img.onload = function() {
                try {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                } catch (e) {
                    console.log('Canvas drawing error:', e);
                    createFallbackReferenceImage();
                }
            };
            img.onerror = function() {
                console.log('Image load error');
                createFallbackReferenceImage();
            };
            img.src = imageData;
        }
        
        function createFallbackReferenceImage() {
            const canvas = document.getElementById('referenceImage');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#ff6b9d';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('見本', canvas.width / 2, canvas.height / 2);
        }

        function initializePuzzle() {
            puzzle = [1, 2, 3, 4, 5, 6, 7, 8, 0];
            emptyPos = 8;
            hintUsedThisRound = false;
            clearSuperHint();
            createReferenceImage();
            renderPuzzle();
            moveCount = 0;
            document.getElementById('moveCount').textContent = moveCount;
            document.getElementById('timeCount').textContent = '00:00';
            document.getElementById('victoryMessage').style.display = 'none';
        }

        function renderPuzzle() {
            const grid = document.getElementById('puzzleGrid');
            const currentPieceSize = getComputedStyle(grid).getPropertyValue('--piece-size');
            const pieceSize = parseInt(currentPieceSize);
            
            grid.innerHTML = '';
            
            for (let i = 0; i < 9; i++) {
                const piece = document.createElement('div');
                piece.className = 'puzzle-piece';
                
                if (puzzle[i] === 0) {
                    piece.classList.add('empty');
                } else {
                    const row = Math.floor((puzzle[i] - 1) / 3);
                    const col = (puzzle[i] - 1) % 3;
                    piece.style.backgroundImage = `url(${imageData})`;
                    piece.style.backgroundPosition = `-${col * pieceSize}px -${row * pieceSize}px`;
                    
                    // ロック機能チェック
                    const isTopRowComplete = puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3;
                    const isLeftColumnComplete = puzzle[0] === 1 && puzzle[3] === 4 && puzzle[6] === 7;
                    
                    if ((isTopRowComplete && (i === 0 || i === 1 || i === 2)) || 
                        (isLeftColumnComplete && (i === 0 || i === 3 || i === 6))) {
                        piece.classList.add('locked');
                        piece.title = isTopRowComplete && (i === 0 || i === 1 || i === 2) ? 
                                      '上段完成済み - 動かせません' : '左列完成済み - 動かせません';
                    } else {
                        // タッチとクリックの両方をサポート（Android対応強化）
                        let touchStarted = false;
                        
                        const handlePieceAction = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            movePiece(i);
                        };
                        
                        // クリックイベント（デスクトップ用）
                        piece.addEventListener('click', handlePieceAction, { passive: false });
                        
                        // タッチイベント（モバイル用）
                        piece.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            touchStarted = true;
                            piece.classList.add('touching');
                        }, { passive: false });
                        
                        piece.addEventListener('touchmove', (e) => {
                            // 指が動いた場合は無効化
                            if (e.touches.length > 0) {
                                const touch = e.touches[0];
                                const rect = piece.getBoundingClientRect();
                                const x = touch.clientX - rect.left;
                                const y = touch.clientY - rect.top;
                                
                                if (x < 0 || x > rect.width || y < 0 || y > rect.height) {
                                    touchStarted = false;
                                    piece.classList.remove('touching');
                                }
                            }
                        }, { passive: false });
                        
                        piece.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            piece.classList.remove('touching');
                            
                            if (touchStarted) {
                                // Android Chromeでの遅延を回避
                                setTimeout(() => {
                                    movePiece(i);
                                }, 0);
                            }
                            touchStarted = false;
                        }, { passive: false });
                        
                        piece.addEventListener('touchcancel', (e) => {
                            piece.classList.remove('touching');
                            touchStarted = false;
                        }, { passive: false });
                    }
                    
                    const hintNumber = document.createElement('div');
                    hintNumber.className = 'hint-number';
                    hintNumber.textContent = puzzle[i];
                    
                    if (showHints) {
                        hintNumber.style.opacity = '1';
                    } else {
                        hintNumber.style.opacity = '0';
                    }
                    
                    piece.appendChild(hintNumber);
                }
                grid.appendChild(piece);
            }
            
            // 超ヒントハイライトを適用
            if (superHintActive && currentSuperHint) {
                applySuperHint();
            }
        }

        function movePiece(pos) {
            // ロック機能チェック
            const isTopRowComplete = puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3;
            const isLeftColumnComplete = puzzle[0] === 1 && puzzle[3] === 4 && puzzle[6] === 7;
            
            if ((isTopRowComplete && (pos === 0 || pos === 1 || pos === 2)) || 
                (isLeftColumnComplete && (pos === 0 || pos === 3 || pos === 6))) {
                return; // ロックされたピースは動かせない
            }
            
            if (!canMove(pos)) return;
            if (!isGameActive) { startGame(); }
            
            [puzzle[pos], puzzle[emptyPos]] = [puzzle[emptyPos], puzzle[pos]];
            emptyPos = pos;
            moveCount++;
            document.getElementById('moveCount').textContent = moveCount;
            
            // 超ヒント手順完了チェック
            if (superHintActive && currentSuperHint) {
                checkSuperHintCompletion();
            }
            
            renderPuzzle();
            
            if (checkWin()) { endGame(); }
        }

        function canMove(pos) {
            const row = Math.floor(pos / 3);
            const col = pos % 3;
            const emptyRow = Math.floor(emptyPos / 3);
            const emptyCol = emptyPos % 3;
            return (Math.abs(row - emptyRow) === 1 && col === emptyCol) ||
                (Math.abs(col - emptyCol) === 1 && row === emptyRow);
        }

        // 超ヒント機能
        function showSuperHint() {
            if (checkWin()) {
                document.getElementById('hintMessage').innerHTML = '🎉 すでに完成しています！';
                return;
            }
            
            // L字型完成チェック - 最優先
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[3] === 4 && puzzle[6] === 7) {
                superHintActive = false;
                currentSuperHint = null;
                document.getElementById('hintMessage').innerHTML = 
                    `🎉 <strong style="color: #4CAF50; font-size: 1.2em;">完璧！こうなったらあとはパネルを回転させるだけで完成です。</strong>`;
                renderPuzzle();
                return;
            }
            
            // 手順1: ①を左上に配置
            if (puzzle[0] !== 1) {
                const pieceOneIndex = puzzle.indexOf(1);
                currentSuperHint = {
                    from: pieceOneIndex,
                    to: 0,
                    piece: 1,
                    step: 1
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="step-number">①</span>を<span class="target-position">左上</span>に配置してください`;
                renderPuzzle();
                return;
            }
            
            // 手順6: ①と③が正しい位置にあり、②が位置1にない場合
            if (puzzle[0] === 1 && puzzle[2] === 3 && puzzle[1] !== 2) {
                const pieceTwoIndex = puzzle.indexOf(2);
                currentSuperHint = {
                    from: pieceTwoIndex,
                    to: 1,
                    piece: 2,
                    step: 6
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="step-number">②</span>を<span class="target-position">上の中央</span>に移動してください`;
                renderPuzzle();
                return;
            }
            
            // 手順7: ④を左下へ移動（上段完成後）
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[6] !== 4 && puzzle[3] !== 4) {
                const pieceFourIndex = puzzle.indexOf(4);
                currentSuperHint = {
                    from: pieceFourIndex,
                    to: 6,
                    piece: 4,
                    step: 7
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="step-number">④</span>を<span class="target-position">左下</span>へ移動してください`;
                renderPuzzle();
                return;
            }
            
            // 手順8: ⑦を右下へ移動
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[6] === 4 && puzzle[8] !== 7 && puzzle[7] !== 7) {
                const pieceSevenIndex = puzzle.indexOf(7);
                currentSuperHint = {
                    from: pieceSevenIndex,
                    to: 8,
                    piece: 7,
                    step: 8
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="step-number">⑦</span>を<span class="target-position">右下</span>へ移動してください`;
                renderPuzzle();
                return;
            }
            
            // 手順9: ⑦を④の右側へ移動
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[6] === 4 && puzzle[7] !== 7) {
                const pieceSevenIndex = puzzle.indexOf(7);
                currentSuperHint = {
                    from: pieceSevenIndex,
                    to: 7,
                    piece: 7,
                    step: 9
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="step-number">⑦</span>を<span class="target-position">④の右側</span>へ移動してください`;
                renderPuzzle();
                return;
            }
            
            // 手順10: ④の上を空白にする
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[6] === 4 && puzzle[7] === 7 && puzzle[3] !== 0) {
                const pieceAtPosition3 = puzzle[3];
                currentSuperHint = {
                    from: 3,
                    to: null,
                    piece: pieceAtPosition3,
                    step: 10
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="target-position">④の上</span>を<span class="step-number">空白</span>にしてください`;
                renderPuzzle();
                return;
            }
            
            // 手順11: ④を上に移動
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[6] === 4 && puzzle[7] === 7 && puzzle[3] === 0 && puzzle[3] !== 4) {
                const pieceFourIndex = puzzle.indexOf(4);
                currentSuperHint = {
                    from: pieceFourIndex,
                    to: 3,
                    piece: 4,
                    step: 11
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="step-number">④</span>を<span class="target-position">上に移動</span>してください`;
                renderPuzzle();
                return;
            }
            
            // 手順12: ⑦を左下へ移動（L字型完成）
            if (puzzle[0] === 1 && puzzle[1] === 2 && puzzle[2] === 3 && puzzle[3] === 4 && puzzle[6] !== 7) {
                const pieceSevenIndex = puzzle.indexOf(7);
                currentSuperHint = {
                    from: pieceSevenIndex,
                    to: 6,
                    piece: 7,
                    step: 12
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="step-number">⑦</span>を<span class="target-position">左下</span>へ移動してください（L字型完成！）`;
                renderPuzzle();
                return;
            }
            
            // 手順2: ①の隣に③を配置
            if (puzzle[1] !== 3) {
                const pieceThreeIndex = puzzle.indexOf(3);
                currentSuperHint = {
                    from: pieceThreeIndex,
                    to: 1,
                    piece: 3,
                    step: 2
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="step-number">③</span>を<span class="target-position">①の隣</span>に配置してください`;
                renderPuzzle();
                return;
            }
            
            // 手順3: ③の真下に②を配置
            if (puzzle[4] !== 2) {
                const pieceTwoIndex = puzzle.indexOf(2);
                currentSuperHint = {
                    from: pieceTwoIndex,
                    to: 4,
                    piece: 2,
                    step: 3
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="step-number">②</span>を<span class="target-position">③の真下</span>に配置してください`;
                renderPuzzle();
                return;
            }
            
            // 手順4: ③の隣を空白にする
            if (puzzle[2] !== 0) {
                const pieceAtPosition2 = puzzle[2];
                currentSuperHint = {
                    from: 2,
                    to: null,
                    piece: pieceAtPosition2,
                    step: 4
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="target-position">③の隣</span>を<span class="step-number">空白</span>にしてください`;
                renderPuzzle();
                return;
            }
            
            // 手順5: 右上の空白に③を移動
            if (puzzle[2] === 0 && puzzle[1] === 3) {
                const pieceThreeIndex = puzzle.indexOf(3);
                currentSuperHint = {
                    from: pieceThreeIndex,
                    to: 2,
                    piece: 3,
                    step: 5
                };
                superHintActive = true;
                document.getElementById('hintMessage').innerHTML = 
                    `🎯 <span class="step-number">③</span>を<span class="target-position">右上の空白</span>に移動してください`;
                renderPuzzle();
                return;
            }
            
            // 手順完了後は通常のヒント
            document.getElementById('hintMessage').innerHTML = 'パズルを解いてください！';
        }

        function applySuperHint() {
            if (!currentSuperHint) return;
            
            const puzzleContainer = document.getElementById('puzzleGrid');
            const tiles = puzzleContainer.children;
            
            // 各手順に応じたハイライト
            if (currentSuperHint.step === 1) {
                // 手順1: ①のピースをロックオン、左上を赤枠
                const pieceOneCurrentIndex = puzzle.indexOf(1);
                if (tiles[pieceOneCurrentIndex] && !tiles[pieceOneCurrentIndex].classList.contains('empty')) {
                    tiles[pieceOneCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[0]) {
                    tiles[0].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 2) {
                // 手順2: ③のピースをロックオン、①の隣（位置1）を赤枠
                const pieceThreeCurrentIndex = puzzle.indexOf(3);
                if (tiles[pieceThreeCurrentIndex] && !tiles[pieceThreeCurrentIndex].classList.contains('empty')) {
                    tiles[pieceThreeCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[1]) {
                    tiles[1].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 3) {
                // 手順3: ②のピースをロックオン、③の真下（位置4）を赤枠
                const pieceTwoCurrentIndex = puzzle.indexOf(2);
                if (tiles[pieceTwoCurrentIndex] && !tiles[pieceTwoCurrentIndex].classList.contains('empty')) {
                    tiles[pieceTwoCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[4]) {
                    tiles[4].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 4) {
                // 手順4: ③の隣（位置2）にあるピースをロックオン、その位置を赤枠
                if (tiles[2] && !tiles[2].classList.contains('empty')) {
                    tiles[2].classList.add('super-hint-piece');
                }
                if (tiles[2]) {
                    tiles[2].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 5) {
                // 手順5: ③のピースをロックオン、右上（位置2）を赤枠
                const pieceThreeCurrentIndex = puzzle.indexOf(3);
                if (tiles[pieceThreeCurrentIndex] && !tiles[pieceThreeCurrentIndex].classList.contains('empty')) {
                    tiles[pieceThreeCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[2]) {
                    tiles[2].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 6) {
                // 手順6: ②のピースをロックオン、上段（位置1）を赤枠
                const pieceTwoCurrentIndex = puzzle.indexOf(2);
                if (tiles[pieceTwoCurrentIndex] && !tiles[pieceTwoCurrentIndex].classList.contains('empty')) {
                    tiles[pieceTwoCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[1]) {
                    tiles[1].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 7) {
                // 手順7: ④のピースをロックオン、左下（位置6）を赤枠
                const pieceFourCurrentIndex = puzzle.indexOf(4);
                if (tiles[pieceFourCurrentIndex] && !tiles[pieceFourCurrentIndex].classList.contains('empty')) {
                    tiles[pieceFourCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[6]) {
                    tiles[6].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 8) {
                // 手順8: ⑦のピースをロックオン、右下（位置8）を赤枠
                const pieceSevenCurrentIndex = puzzle.indexOf(7);
                if (tiles[pieceSevenCurrentIndex] && !tiles[pieceSevenCurrentIndex].classList.contains('empty')) {
                    tiles[pieceSevenCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[8]) {
                    tiles[8].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 9) {
                // 手順9: ⑦のピースをロックオン、④の右側（位置7）を赤枠
                const pieceSevenCurrentIndex = puzzle.indexOf(7);
                if (tiles[pieceSevenCurrentIndex] && !tiles[pieceSevenCurrentIndex].classList.contains('empty')) {
                    tiles[pieceSevenCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[7]) {
                    tiles[7].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 10) {
                // 手順10: ④の上（位置3）にあるピースをロックオン、その位置を赤枠
                if (tiles[3] && !tiles[3].classList.contains('empty')) {
                    tiles[3].classList.add('super-hint-piece');
                }
                if (tiles[3]) {
                    tiles[3].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 11) {
                // 手順11: ④のピースをロックオン、上（位置3）を赤枠
                const pieceFourCurrentIndex = puzzle.indexOf(4);
                if (tiles[pieceFourCurrentIndex] && !tiles[pieceFourCurrentIndex].classList.contains('empty')) {
                    tiles[pieceFourCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[3]) {
                    tiles[3].classList.add('super-hint-target');
                }
            } else if (currentSuperHint.step === 12) {
                // 手順12: ⑦のピースをロックオン、左下（位置6）を赤枠
                const pieceSevenCurrentIndex = puzzle.indexOf(7);
                if (tiles[pieceSevenCurrentIndex] && !tiles[pieceSevenCurrentIndex].classList.contains('empty')) {
                    tiles[pieceSevenCurrentIndex].classList.add('super-hint-piece');
                }
                if (tiles[6]) {
                    tiles[6].classList.add('super-hint-target');
                }
            } else {
                // 通常のヒント
                const targetPieceIndex = puzzle.indexOf(currentSuperHint.piece);
                if (tiles[targetPieceIndex] && !tiles[targetPieceIndex].classList.contains('empty')) {
                    tiles[targetPieceIndex].classList.add('super-hint-piece');
                }
                if (tiles[currentSuperHint.to]) {
                    tiles[currentSuperHint.to].classList.add('super-hint-target');
                }
            }
        }

        function checkSuperHintCompletion() {
            if (!superHintActive || !currentSuperHint) return;
            
            let stepCompleted = false;
            let completionMessage = '';
            
            if (currentSuperHint.step === 1 && puzzle[0] === 1) {
                stepCompleted = true;
                completionMessage = '✅ <strong style="color: #4CAF50;">①が左上に配置されました！</strong><br>次の超ヒントを押してください。';
            } else if (currentSuperHint.step === 2 && puzzle[1] === 3) {
                stepCompleted = true;
                completionMessage = '✅ <strong style="color: #4CAF50;">③が①の隣に配置されました！</strong><br>次の超ヒントを押してください。';
            } else if (currentSuperHint.step === 3 && puzzle[4] === 2) {
                stepCompleted = true;
                completionMessage = '✅ <strong style="color: #4CAF50;">②が③の真下に配置されました！</strong><br>次の超ヒントを押してください。';
            } else if (currentSuperHint.step === 4 && puzzle[2] === 0) {
                stepCompleted = true;
                completionMessage = '✅ <strong style="color: #4CAF50;">③の隣が空白になりました！</strong><br>次の超ヒントを押してください。';
            } else if (currentSuperHint.step === 5 && puzzle[2] === 3) {
                stepCompleted = true;
                completionMessage = '✅ <strong style="color: #4CAF50;">③が右上に移動しました！</strong><br>次の超ヒントを押してください。';
            } else if (currentSuperHint.step === 6 && puzzle[1] === 2 && puzzle[0] === 1 && puzzle[2] === 3) {
                stepCompleted = true;
                completionMessage = '🎉 <strong style="color: #FF6B9D; font-size: 1.1em;">②を上段に移動しました！上段が完成しました！</strong><br><span style="color: #666;">上段はもう動かしません。次の超ヒントを押してください。</span>';
            } else if (currentSuperHint.step === 7 && puzzle[6] === 4) {
                stepCompleted = true;
                completionMessage = '✅ <strong style="color: #4CAF50;">④を左下に移動しました！</strong><br>次の超ヒントを押してください。';
            } else if (currentSuperHint.step === 8 && puzzle[8] === 7) {
                stepCompleted = true;
                completionMessage = '✅ <strong style="color: #4CAF50;">⑦を右下に移動しました！</strong><br>次の超ヒントを押してください。';
            } else if (currentSuperHint.step === 9 && puzzle[7] === 7) {
                stepCompleted = true;
                completionMessage = '✅ <strong style="color: #4CAF50;">⑦を④の右側に移動しました！</strong><br>次の超ヒントを押してください。';
            } else if (currentSuperHint.step === 10 && puzzle[3] === 0) {
                stepCompleted = true;
                completionMessage = '✅ <strong style="color: #4CAF50;">④の上が空白になりました！</strong><br>次の超ヒントを押してください。';
            } else if (currentSuperHint.step === 11 && puzzle[3] === 4) {
                stepCompleted = true;
                completionMessage = '✅ <strong style="color: #4CAF50;">④を上に移動しました！</strong><br>次の超ヒントを押してください。';
            } else if (currentSuperHint.step === 12 && puzzle[6] === 7 && puzzle[3] === 4) {
                stepCompleted = true;
                completionMessage = '🎉 <strong style="color: #FF6B9D; font-size: 1.1em;">⑦を左下に移動しました！L字型が完成しました！</strong><br><span style="color: #666;">④と⑦はもう動かしません。次の超ヒントを押してください。</span>';
            }
            
            if (stepCompleted) {
                clearSuperHint();
                document.getElementById('hintMessage').innerHTML = completionMessage;
            }
        }

        function clearSuperHint() {
            superHintActive = false;
            currentSuperHint = null;
            
            // すべてのハイライトを削除
            document.querySelectorAll('.puzzle-piece').forEach(tile => {
                tile.classList.remove('super-hint-piece', 'super-hint-target');
            });
            
            document.getElementById('hintMessage').innerHTML = 
                '「超ヒント」ボタンを押すと、次に配置すべきピースと位置を教えます！';
        }

        function shufflePuzzle() {
            stopGame();
            hintUsedThisRound = false;
            clearSuperHint();
            
            const pieces = [1, 2, 3, 4, 5, 6, 7, 8, 0];
            
            for (let i = pieces.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pieces[i], pieces[j]] = [pieces[j], pieces[i]];
            }
            
            puzzle = pieces;
            emptyPos = puzzle.indexOf(0);
            
            if (!isSolvable(puzzle)) {
                let firstNonEmpty = -1, secondNonEmpty = -1;
                for (let i = 0; i < 9; i++) {
                    if (puzzle[i] !== 0) {
                        if (firstNonEmpty === -1) {
                            firstNonEmpty = i;
                        } else if (secondNonEmpty === -1) {
                            secondNonEmpty = i;
                            break;
                        }
                    }
                }
                if (firstNonEmpty !== -1 && secondNonEmpty !== -1) {
                    [puzzle[firstNonEmpty], puzzle[secondNonEmpty]] = [puzzle[secondNonEmpty], puzzle[firstNonEmpty]];
                }
            }
            
            renderPuzzle();
            document.getElementById('victoryMessage').style.display = 'none';
        }
        
        function isSolvable(arr) {
            let inversions = 0;
            
            for (let i = 0; i < 9; i++) {
                if (arr[i] === 0) continue;
                for (let j = i + 1; j < 9; j++) {
                    if (arr[j] === 0) continue;
                    if (arr[i] > arr[j]) {
                        inversions++;
                    }
                }
            }
            
            return inversions % 2 === 0;
        }

        function resetPuzzle() {
            stopGame();
            puzzle = [1, 2, 3, 4, 5, 6, 7, 8, 0];
            emptyPos = 8;
            clearSuperHint();
            renderPuzzle();
            document.getElementById('victoryMessage').style.display = 'none';
        }

        function toggleHint() {
            showHints = !showHints;
            const hintButton = document.getElementById('hintButton');
            
            if (showHints) {
                hintButton.textContent = 'ヒント OFF';
                hintButton.classList.add('active');
                hintUsedThisRound = true;
            } else {
                hintButton.textContent = 'ヒント';
                hintButton.classList.remove('active');
            }
            
            const hintNumbers = document.querySelectorAll('.hint-number');
            hintNumbers.forEach(hint => {
                if (showHints) {
                    hint.style.opacity = '1';
                } else {
                    hint.style.opacity = '0';
                }
            });
        }

        function startGame() {
            if (isGameActive) return;
            isGameActive = true;
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopGame() {
            isGameActive = false;
            if (timerInterval) { 
                clearInterval(timerInterval); 
                timerInterval = null; 
            }
            moveCount = 0;
            document.getElementById('moveCount').textContent = '0';
            document.getElementById('timeCount').textContent = '00:00';
        }

        function endGame() {
            isGameActive = false;
            if (timerInterval) { 
                clearInterval(timerInterval); 
                timerInterval = null; 
            }
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const isNewRecord = !bestTime || elapsed < bestTime;
            
            if (isNewRecord) {
                bestTime = elapsed;
                updateBestTimeDisplay();
            }
            
            showVictoryMessage(elapsed, isNewRecord);
        }

        function getTimeMessage(seconds) {
            const messages = {
                神: [
                    "👑 神レベル！あなたはスライドパズルの神です！",
                    "🔥 人間を超越した速さ！伝説の記録！",
                    "✨ 神業！横綱も脱帽です！"
                ],
                横綱: [
                    "🥇 横綱レベル！プロ級の実力です！",
                    "⚡ 超人的な速さ！頭脳明晰の証拠！",
                    "🎯 完璧な判断力！見事です！"
                ],
                プロ: [
                    "⚡ 30秒切り！プロ級の速さです！",
                    "🎊 実力者の証明！見事な手腕！",
                    "🌟 安定した高速解答！流石です！"
                ],
                上級者: [
                    "🚀 20秒台突入！脳の回転が超高速！",
                    "💨 驚異的なスピード！素晴らしい！",
                    "⭐ 上級者の領域！その調子！"
                ],
                本番: [
                    "🌸 本番レベルクリア！制限時間内達成！",
                    "💪 40秒台！素晴らしい実力ですね！",
                    "📈 順調なペース！着実に上達中！"
                ],
                一分切り: [
                    "👏 1分切り達成！立派な実力です！",
                    "🎉 50秒台！集中力が素晴らしい！",
                    "✨ 1分以内クリア！頭脳明晰ですね！"
                ],
                達成: [
                    "🎊 完成おめでとう！あなたにはできる力がある！",
                    "🏆 諦めずに最後まで！その姿勢が一番大切！",
                    "✨ 完成の瞬間こそが最高の宝物！素晴らしい！",
                    "🌈 できた！この達成感を忘れないで！",
                    "🌟 やればできる！自分を信じた結果です！",
                    "💪 完成という成功体験があなたの財産！",
                    "🎯 最後まで頑張ったあなたが一番輝いてる！"
                ]
            };

            let category, title;
            if (seconds < 10) {
                category = "神";
                title = "神レベル";
            } else if (seconds < 20) {
                category = "横綱";
                title = "横綱レベル";
            } else if (seconds < 30) {
                category = "プロ";
                title = "プロ級";
            } else if (seconds < 40) {
                category = "上級者";
                title = "上級者レベル";
            } else if (seconds < 50) {
                category = "本番";
                title = "本番レベル";
            } else if (seconds < 60) {
                category = "一分切り";
                title = "1分切りレベル";
            } else {
                category = "達成";
                title = "達成レベル";
            }

            const messageList = messages[category];
            const randomMessage = messageList[Math.floor(Math.random() * messageList.length)];
            
            return { title, message: randomMessage };
        }

        function updateBestTimeDisplay() {
            if (bestTime) {
                const minutes = Math.floor(bestTime / 60);
                const seconds = bestTime % 60;
                const timeStr = minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${seconds}s`;
                document.getElementById('bestTimeDisplay').textContent = timeStr;
            }
        }

        function showVictoryMessage(time, isNewRecord) {
            const { title, message } = getTimeMessage(time);
            const minutes = Math.floor(time / 60);
            const seconds = time % 60;
            const timeStr = minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${seconds}秒`;
            
            const popupHtml = `
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">
                    ${isNewRecord ? '🎉 ベストタイム更新！' : '📊 クリア！'}
                </div>
                <div style="font-size: 16px; margin-bottom: 10px;">
                    ⏰ ${timeStr} - ${title}
                </div>
                <div style="font-size: 14px; margin-bottom: 15px;">
                    🎯 ${moveCount}手
                </div>
                <div style="font-size: 15px; line-height: 1.4; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">
                    ${message}
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="closeVictoryMessage()" style="background: white; color: #4CAF50; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold;">続ける</button>
                </div>
            `;

            document.getElementById('victoryPopup').innerHTML = popupHtml;
            document.getElementById('victoryOverlay').style.display = 'flex';
        }

        function closeVictoryMessage() {
            document.getElementById('victoryOverlay').style.display = 'none';
        }

        // オーバーレイクリックで閉じる
        document.addEventListener('click', function(e) {
            if (e.target.id === 'victoryOverlay') {
                closeVictoryMessage();
            }
        });

        function updateTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timeCount').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function checkWin() {
            for (let i = 0; i < 8; i++) {
                if (puzzle[i] !== i + 1) return false;
            }
            return puzzle[8] === 0;
        }

        // スマホでのダブルタップズーム防止と高速タッチ対応（Android強化）
        let touchCount = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchCount++;
            
            // マルチタッチを防止
            if (e.touches.length > 1) {
                e.preventDefault();
                return false;
            }
            
            // Android Chromeの遅延対応
            if (touchCount === 1) {
                setTimeout(() => {
                    touchCount = 0;
                }, 500);
            }
        }, { passive: false });

        // ダブルタップ防止をより効果的に（Android対応）
        let lastTouchEnd = 0;
        let preventDoubleTap = false;
        
        document.addEventListener('touchend', function(e) {
            const now = Date.now();
            
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
                preventDoubleTap = true;
                setTimeout(() => {
                    preventDoubleTap = false;
                }, 400);
                return false;
            }
            
            if (preventDoubleTap) {
                e.preventDefault();
                return false;
            }
            
            lastTouchEnd = now;
        }, { passive: false });
        
        // Android Chrome特有の問題対応
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        // iOS Safariでの300msディレイを完全に除去
        document.addEventListener('touchstart', function() {}, { passive: true });
    </script>
</body>
</html>
